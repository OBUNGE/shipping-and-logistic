<!-- ðŸ“„ File: app/views/sellers/show.html.erb -->


<header class="storefront-header text-center mb-4">
  <% if @seller.store_banner_url.present? %>
    <%= image_tag @seller.store_banner_url,
        class: "img-fluid rounded mb-3",
        style: "object-fit: cover; width: 100%; height: 250px;",
        alt: "#{@seller.store_name || @seller.name} online store banner" %>
  <% else %>
    <%= image_tag asset_path("store-banner-placeholder.png"),
        class: "img-fluid rounded mb-3",
        style: "object-fit: cover; width: 100%; height: 250px;",
        alt: "Default store banner placeholder" %>
  <% end %>

  <div class="d-flex align-items-center justify-content-center gap-3">
    <% if @seller.store_logo_url.present? %>
      <%= image_tag @seller.store_logo_url,
          class: "rounded-circle border",
          style: "width: 80px; height: 80px; object-fit: cover;",
          alt: "#{@seller.store_name || @seller.name} store logo" %>
    <% else %>
      <%= image_tag asset_path("store-logo-placeholder.png"),
          class: "rounded-circle border",
          style: "width: 80px; height: 80px; object-fit: cover;",
          alt: "Default store logo placeholder" %>
    <% end %>
    <h1 class="fw-bold"><%= @seller.store_name.presence || @seller.name %></h1>
  </div>

  <p class="text-muted"><%= @seller.store_description %></p>
</header>

<section class="mb-4 text-center" aria-label="Filters and Sorting">
  <%= form_with url: seller_path(@seller.store_slug), method: :get, local: true, id: "filter-form" do %>
    <%= select_tag :category,
          options_for_select(@categories, params[:category]),
          prompt: "Filter by Category",
          class: "form-select w-auto d-inline-block me-2",
          id: "category-select" %>

    <%= select_tag :subcategory,
          options_for_select(@subcategories, params[:subcategory]),
          prompt: "Filter by Subcategory",
          class: "form-select w-auto d-inline-block me-2",
          id: "subcategory-select" %>

    <%= select_tag :sort,
          options_for_select([["Newest", ""], ["Price: Low to High", "price_asc"], ["Price: High to Low", "price_desc"]], params[:sort]),
          class: "form-select w-auto d-inline-block me-2" %>

    <%= submit_tag "Apply Filters", class: "btn btn-outline-secondary me-2" %>
    <%= link_to "Clear Filters", seller_path(@seller.store_slug), class: "btn btn-outline-danger" %>
  <% end %>
</section>

<% if @no_products_found %>
  <div class="alert alert-warning text-center">
    No products found for the selected filters.
  </div>
<% end %>

<section class="row" aria-label="Product Listings">
  <% @products.each do |product| %>
    <article class="col-6 col-sm-4 col-md-3 col-lg-5th mb-3">
      <div class="card h-100 shadow-sm">
        <% if product.image_url.present? %>
          <%= image_tag product.image_url,
              class: "card-img-top",
              style: "object-fit: cover; width: 100%; height: 300px;",
              alt: "#{product.title} product image" %>
        <% else %>
          <%= image_tag asset_path("placeholder.png"),
              class: "card-img-top",
              style: "object-fit: cover; width: 100%; height: 300px;",
              alt: "No image available for #{product.title}" %>
        <% end %>

        <div class="card-body">
          <h2 class="card-title h5">
            <%= link_to product.title, product_path(product), class: "text-decoration-none link-hover" %>
          </h2>

          <% if product.discount&.active? && product.discount.percentage.to_f > 0 %>
            <% discounted_price = product.discounted_price %>
            <p class="card-text fw-semibold mb-1">
              <span class="text-muted text-decoration-line-through me-2">
                <%= display_price(product.price) %>
              </span>
              <span class="text-danger">
                <%= display_price(discounted_price) %>
              </span>
            </p>
            <span class="badge bg-success">-<%= product.discount.percentage.to_i %>% Off</span>
          <% else %>
            <p class="card-text fw-semibold">
              <%= display_price(product.price) %>
            </p>
          <% end %>

          <div class="mt-2">
            <% if product.category.present? %>
              <span class="badge bg-secondary me-1"><%= product.category.name %></span>
            <% end %>
            <% if product.category&.parent.present? %>
              <span class="badge bg-info"><%= product.category.parent.name %></span>
            <% end %>
          </div>
        </div>
      </div>
    </article>
  <% end %>
</section>

<div class="mt-4 d-flex justify-content-center" aria-label="Pagination">
  <%= paginate @products %>
</div>

<!-- âœ… Fixed Dynamic Script -->
<script type="module">
  document.addEventListener("DOMContentLoaded", () => {
    const categorySelect = document.getElementById("category-select");
    const subcategorySelect = document.getElementById("subcategory-select");
    const filterForm = document.getElementById("filter-form");

    // Dynamic subcategory loading
    categorySelect.addEventListener("change", () => {
      const selectedCategory = categorySelect.value;
      const slug = "<%= @seller.store_slug %>";

      fetch(`/sellers/${slug}/subcategories?category=${encodeURIComponent(selectedCategory)}`)
        .then(response => response.json())
        .then(data => {
          subcategorySelect.innerHTML = '<option value="">Filter by Subcategory</option>';
          data.forEach(sub => {
            const option = document.createElement("option");
            option.value = sub.slug;
            option.textContent = sub.name;
            subcategorySelect.appendChild(option);
          });
        });
    });

    // âœ… Async file upload handler
    filterForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const bannerUploaded = await uploadFile("store_banner", "store_banner_url", "store-banners");
      if (!bannerUploaded) {
        return;
      }

      filterForm.submit();
    });
  });
</script>

<!-- ðŸ“„ File: app/views/sellers/show.html.erb -->

<style>
  /* -------------- GLOBAL RESPONSIVE FIXES ------------------ */
  .storefront-header {
    padding: 10px 15px;
  }

  .storefront-header img {
    border-radius: 8px;
  }

  /* Responsive Grid Fix */
  @media (min-width: 992px) {
    .col-lg-5th {
      flex: 0 0 20%;
      max-width: 20%;
    }
  }

  /* Card Styling */
  .product-card {
    border-radius: 10px;
    overflow: hidden;
    transition: transform 0.2s ease;
  }

  .product-card:hover {
    transform: translateY(-4px);
  }

  /* Uniform Image Height */
  .product-image {
    height: 220px;
    object-fit: cover;
  }

  @media (min-width: 576px) {
    .product-image {
      height: 250px;
    }
  }

  @media (min-width: 992px) {
    .product-image {
      height: 300px;
    }
  }

  /* Title Styling */
  .product-title {
    font-size: 16px;
    font-weight: 600;
    height: 45px;
    overflow: hidden;
  }

  /* Price Styling */
  .price-line {
    font-size: 17px;
    font-weight: bold;
  }

  /* Filter Bar */
  .filter-bar {
    padding: 10px;
    background: #fff;
    border-radius: 8px;
  }

  /* Store Logo */
  .store-logo {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #ddd;
  }

  .store-banner {
    width: 100%;
    height: 250px;
    border-radius: 8px;
    object-fit: cover;
  }

  /* Mobile spacing */
  @media (max-width: 576px) {
    .product-title {
      font-size: 14px;
      height: 40px;
    }

    .price-line {
      font-size: 15px;
    }

    .filter-bar select {
      width: 100% !important;
      margin-bottom: 10px !important;
    }

    .filter-bar button {
      width: 100%;
      margin-bottom: 10px;
    }
  }
</style>
