<h2>
  <% if order.buyer.present? %>
    Hi <%= order.buyer.name.presence || [order.buyer.first_name, order.buyer.last_name].compact.join(" ").presence || order.buyer.email %>,
  <% else %>
    Hi <%= order.name.presence || [order.first_name, order.last_name].compact.join(" ").presence || order.email %>,
  <% end %>
</h2>

<p>Thank you for your payment for Order ##<%= order.id %>.</p>
<p>Your order will be delivered to you.</p>

<p>
  <strong>Amount Paid:</strong>
  <%= number_to_currency(order.total, unit: "KES ") %>
  <% usd_total = ExchangeRateService.convert(order.total, from: "KES", to: "USD") %>
  <span class="text-muted small">≈ <%= number_to_currency(usd_total, unit: "USD ") %></span>
</p>

<% latest_payment = order.payments.last %>
<p>
  <strong>Payment Method:</strong>
  <%= latest_payment&.provider&.humanize || "N/A" %>
</p>

<p>
  <strong>Order Date:</strong>
  <%= order.created_at.strftime("%B %d, %Y at %I:%M %p") %>
</p>

<p>
  <strong>Shipping Address:</strong><br>
  <%= order.name.presence || [order.first_name, order.last_name].compact.join(" ") %><br>
  <%= order.address %><br>
  <%= order.city %>, <%= order.county.presence || order.region.presence || "" %><br>
  <%= order.country %><br>
  Phone: <%= order.phone_number %><br>
  <% if order.alternate_contact.present? %>
    Alternate Contact: <%= order.alternate_contact %><br>
  <% end %>
</p>

<h4>Order Summary</h4>
<table style="width:100%; border-collapse: collapse;" border="1" cellpadding="8">
  <thead style="background-color:#f8f9fa;">
    <tr>
      <th align="left">Product</th>
      <th align="left">Variants</th>
      <th align="center">Quantity</th>
      <th align="right">Unit Price</th>
      <th align="right">Subtotal</th>
    </tr>
  </thead>
  <tbody>
    <% order.order_items.each do |item| %>
      <tr>
        <td><%= item.product.title %></td>
        <td>
          <% if item.respond_to?(:variants) && item.variants.present? %>
            <%= item.variants.map { |v| "#{v.name}: #{v.value}" }.join(", ") %>
          <% elsif item.variant.present? %>
            <%= "#{item.variant.name}: #{item.variant.value}" %>
          <% else %>
            —
          <% end %>
        </td>
        <td align="center"><%= item.quantity %></td>
        <td align="right"><%= number_to_currency(item.unit_price, unit: "KES ") %></td>
        <td align="right"><%= number_to_currency(item.subtotal, unit: "KES ") %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<% subtotal = order.order_items.sum(&:subtotal) %>
<% shipping_total = order.order_items.sum { |oi| oi.shipping || 0 } %>

<p>
  <strong>Subtotal:</strong>
  <%= number_to_currency(subtotal, unit: "KES ") %>
</p>
<p>
  <strong>Shipping:</strong>
  <%= number_to_currency(shipping_total, unit: "KES ") %>
</p>
<p>
  <strong>Total:</strong>
  <%= number_to_currency(order.total, unit: "KES ") %>
  <% usd_total = ExchangeRateService.convert(order.total, from: "KES", to: "USD") %>
  <span class="text-muted small">≈ <%= number_to_currency(usd_total, unit: "USD ") %></span>
</p>

<p>If you have any questions about your order, feel free to reply to this email or contact our support team.</p>
<p>Thank you for shopping with us!</p>
<p>Best regards,<br>tajaone</p>
