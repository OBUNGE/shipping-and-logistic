<h2>
  <% if order.buyer.present? %>
    Hi <%= order.buyer.full_name.presence || order.buyer.email %>,
  <% else %>
    Hi <%= [order.first_name, order.last_name].compact.join(" ") %>,
  <% end %>
</h2>

<p>Thank you for your payment for Order ##<%= order.id %>.</p>
<p>Your order will be delivered to you.</p>

<p>
  <strong>Amount Paid:</strong>
  <%= number_to_currency(order.total, unit: "KES ") %>
  <% usd_total = ExchangeRateService.convert(order.total, from: "KES", to: "USD") %>
  <span class="text-muted small">≈ <%= number_to_currency(usd_total, unit: "USD ") %></span>
</p>

<% latest_payment = order.payments.last %>
<p>
  <strong>Payment Method:</strong>
  <%= latest_payment&.provider&.humanize || "N/A" %>
</p>

<p>
  <strong>Order Date:</strong>
  <%= order.created_at.strftime("%B %d, %Y at %I:%M %p") %>
</p>

<p>
  <strong>Shipping Address:</strong><br>
  <%= [order.first_name, order.last_name].compact.join(" ") %><br>
  <%= order.address %><br>
  <%= order.city %>, <%= order.county.presence || order.region.presence || "" %><br>
  <%= order.country %><br>
  Phone: <%= order.phone_number %><br>
  <% if order.alternate_contact.present? %>
    Alternate Contact: <%= order.alternate_contact %><br>
  <% end %>
</p>

<h4>Order Summary</h4>
<table>
  <thead>
    <tr>
      <th>Product</th>
      <th>Variant</th>
      <th>Quantity</th>
      <th>Unit Price</th>
      <th>Subtotal</th>
    </tr>
  </thead>
  <tbody>
    <% order.order_items.each do |item| %>
      <tr>
        <td><%= item.product.title %></td>
        <td><%= item.variant.present? ? "#{item.variant.name}: #{item.variant.value}" : "—" %></td>
        <td><%= item.quantity %></td>
        <td><%= number_to_currency(item.unit_price, unit: "KES ") %></td>
        <td><%= number_to_currency(item.subtotal, unit: "KES ") %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<% subtotal = order.order_items.sum(&:subtotal) %>
<% shipping_total = order.order_items.sum { |oi| oi.shipping || 0 } %>

<p>
  <strong>Subtotal:</strong>
  <%= number_to_currency(subtotal, unit: "KES ") %>
</p>
<p>
  <strong>Shipping:</strong>
  <%= number_to_currency(shipping_total, unit: "KES ") %>
</p>
<p>
  <strong>Total:</strong>
  <%= number_to_currency(order.total, unit: "KES ") %>
  <% usd_total = ExchangeRateService.convert(order.total, from: "KES", to: "USD") %>
  <span class="text-muted small">≈ <%= number_to_currency(usd_total, unit: "USD ") %></span>
</p>

<p>If you have any questions about your order, feel free to reply to this email or contact our support team.</p>
<p>Thank you for shopping with us!</p>
<p>Best regards,<br>tajaone</p>
