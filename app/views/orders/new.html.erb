<div class="container my-5">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body p-5">

      <h1 class="card-title mb-4 text-center fw-bold text-primary">
        ðŸ›’ Checkout
      </h1>
      <hr class="mb-4">

      <%# --- 1. SINGLE PRODUCT CHECKOUT --- %>
      <% if @product.present? %>
        <div class="bg-light p-4 rounded-3 mb-4">
          <h4 class="fw-semibold text-secondary mb-3">Product Summary</h4>
          <ul class="list-unstyled mb-0">
            <li><strong>Product:</strong> <%= @product.title %></li>
            <li><strong>Price per unit:</strong>
              <% if @product.discount&.active? %>
                <span class="text-decoration-line-through text-muted">
                  <%= display_price(@product.price) %>
                </span>
                <span class="text-success fw-bold ms-2">
                  <%= display_price(@product.discounted_price) %>
                </span>
                <small class="text-success ms-1">(<%= @product.discount.percentage %>% OFF)</small>
              <% else %>
                <%= display_price(@product.price) %>
              <% end %>
            </li>
            <li><strong>Seller:</strong> <%= @product.seller_name %></li>
            <li><strong>Delivery:</strong> <%= @product.delivery_estimate %></li>
          </ul>
        </div>

        <%= form_with model: Order.new, url: product_orders_path(@product), local: true, html: { class: "checkout-form" } do |f| %>

          <% if @product.variants.any? %>
            <div class="mb-3">
              <%= f.label :variant_id, "Choose Variant", class: "form-label fw-semibold" %>
              <%= f.select :variant_id,
                options_for_select(@product.variants.map do |v|
                  base_price = @product.discount&.active? ? @product.discounted_price : @product.price
                  final_price = base_price + (v.price_modifier || 0)
                  label = "#{v.name}: #{v.value} â€” #{display_price(final_price)}"
                  [label, v.id]
                end),
                { prompt: "Select a variant" },
                class: "form-select shadow-sm", required: true %>
            </div>
          <% end %>

          <div class="mb-3">
            <%= f.label :quantity, "Quantity", class: "form-label fw-semibold" %>
            <%= f.number_field :quantity, value: 1, min: 1, class: "form-control shadow-sm", required: true %>
          </div>

          <%= render "orders/shared_checkout_fields", f: f %>

          <%# âœ… POD option restricted to Nairobi %>
          <% if f.object.city&.downcase == "nairobi" || f.object.county&.downcase == "nairobi" %>
            <div class="form-check mb-4">
              <%= f.radio_button :provider, "pod", class: "form-check-input", id: "provider_pod" %>
              <%= f.label :provider_pod, "Pay on Delivery (Nairobi only)", class: "form-check-label fw-semibold text-success" %>
            </div>
          <% end %>

          <div class="alert alert-info small mt-3">
            ðŸšš Shipping will be calculated after you enter delivery details.<br>
            âœ… Free shipping for orders above 
            <strong>
              <%= @product.seller.city&.downcase == "nairobi" ? "5000 KES (Nairobi)" : "7000 KES (Upcountry)" %>
            </strong>
          </div>

          <%= f.submit "Confirm & Pay", class: "btn btn-success w-100 fw-bold py-2 shadow-sm" %>
        <% end %>

      <%# --- 2. CART CHECKOUT --- %>
      <% elsif @order.present? && @cart_items.present? %>
        <h4 class="fw-semibold text-secondary mb-3">Order Summary</h4>
        <div class="table-responsive mb-4">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th>Image</th>
                <th>Variants</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <% @cart_items.each do |item| %>
                <% product  = item[:product] %>
                <% variants = Array(item[:variants]) %>
                <tr>
                  <td><%= product.title %></td>
                  <td class="text-center">
                    <% image_url = variants.first&.primary_image_url.presence || product.primary_image_url.presence %>
                    <% if image_url.present? %>
                      <%= image_tag image_url, class: "img-thumbnail border-0 rounded-3 shadow-sm",
                                    style: "width: 60px; height: 60px; object-fit: cover;" %>
                    <% else %>
                      <%= image_tag asset_path("placeholder.jpg"), class: "img-thumbnail border-0 rounded-3 shadow-sm",
                                    style: "width: 60px; height: 60px; object-fit: cover;" %>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <% if variants.any? %>
                      <% variants.each do |v| %>
                        <span class="badge bg-info text-dark me-1">
                          <%= "#{v.name}: #{v.value}" %>
                        </span>
                      <% end %>
                    <% else %>
                      <span class="text-muted">â€”</span>
                    <% end %>
                  </td>
                  <td><%= item[:quantity] %></td>
                  <td>
                    <% if product.discount&.active? %>
                      <span class="text-decoration-line-through text-muted">
                        <%= display_price(product.price) %>
                      </span>
                      <span class="text-success fw-bold ms-2">
                        <%= display_price(item[:unit_price]) %>
                      </span>
                    <% else %>
                      <%= display_price(item[:unit_price]) %>
                    <% end %>
                  </td>
                  <td><%= display_price(item[:subtotal]) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <% subtotal = @cart_items.sum { |i| i[:subtotal] } %>

        <div class="mb-4">
          <h5>Subtotal: <%= display_price(subtotal) %></h5>
          <div class="alert alert-info small mt-2">
            ðŸšš Shipping will be calculated after you enter delivery details.<br>
            âœ… Free shipping thresholds: 
            <strong>Nairobi: 5000 KES</strong>, 
            <strong>Upcountry: 7000 KES</strong>, 
            <strong>International: 10000 KES</strong>
          </div>
        </div>
        
        <%= form_with model: @order, local: true, html: { class: "checkout-form" } do |f| %>
          <%= render "orders/shared_checkout_fields", f: f %>

          <%# âœ… POD option restricted to Nairobi %>
          <% if f.object.city&.downcase == "nairobi" || f.object.county&.downcase == "nairobi" %>
            <div class="form-check mb-4">
              <%= f.radio_button :provider, "pod", class: "form-check-input", id: "provider_pod" %>
              <%= f.label :provider_pod, "Pay on Delivery (Nairobi only)", class: "form-check-label fw-semibold text-success" %>
            </div>
          <% end %>

          <%= f.submit "Confirm & Pay", class: "btn btn-success w-100 fw-bold py-2 shadow-sm" %>
        <% end %>

      <% else %>
        <p class="text-muted fs-5">Your cart is empty.</p>
        <%= link_to "Back to Products", products_path, class: "btn btn-primary fw-semibold" %>
      <% end %>
    </div>
  </div>
</div>


<style>
  .checkout-form label { color: #444; }
  .checkout-form input, .checkout-form textarea, .checkout-form select {
    border-radius: 0.5rem;
  }
  .checkout-form input:focus, .checkout-form select:focus, .checkout-form textarea:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.15rem rgba(13,110,253,.25);
  }
  .card {
    border-radius: 1rem;
  }
  h4.fw-semibold {
    margin-top: 1rem;
  }
</style>
