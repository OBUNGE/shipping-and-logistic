<div class="container my-5">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body p-5">

      <h1 class="card-title mb-4 text-center fw-bold text-primary">
        ðŸ›’ Checkout
      </h1>
      <hr class="mb-4">

      <%# --- 1. SINGLE PRODUCT CHECKOUT --- %>
      <% if @product.present? %>
        <div class="bg-light p-4 rounded-3 mb-4">
          <h4 class="fw-semibold text-secondary mb-3">Product Summary</h4>
          <ul class="list-unstyled mb-0">
            <li><strong>Product:</strong> <%= @product.title %></li>
            <li><strong>Price per unit:</strong> <%= display_price(@product.price) %></li>
            <li><strong>Seller:</strong> <%= @product.seller.company_name.presence || @product.seller.name.presence || "Unknown Seller" %></li>
            <li><strong>Delivery:</strong> <%= @product.estimated_delivery_range.presence || "2â€“5 business days" %></li>
            <li><strong>Shipping:</strong> <%= display_price(@product.shipping_cost || 0) %></li>
          </ul>
        </div>

        <%= form_with model: Order.new, url: product_orders_path(@product), local: true, html: { class: "checkout-form" } do |f| %>

          <% if @product.variants.any? %>
            <div class="mb-3">
              <%= f.label :variant_id, "Choose Variant", class: "form-label fw-semibold" %>
              <%= f.select :variant_id,
                options_for_select(@product.variants.map do |v|
                  label = "#{v.name}: #{v.value}"
                  if v.price_modifier.present? && v.price_modifier != 0
                    label += " (+" + display_price(v.price_modifier) + ")"
                  end
                  [label, v.id]
                end),
                { prompt: "Select a variant" },
                class: "form-select shadow-sm", required: true %>
            </div>
          <% end %>

          <div class="mb-3">
            <%= f.label :quantity, "Quantity", class: "form-label fw-semibold" %>
            <%= f.number_field :quantity, value: 1, min: 1, class: "form-control shadow-sm", required: true %>
          </div>

          <div class="mb-3">
            <%= f.label :currency, "Choose Currency", class: "form-label fw-semibold" %>
            <%= f.select :currency,
              options_for_select([["USD", "USD"], ["KES", "KES"]], selected: "KES"),
              {}, class: "form-select shadow-sm" %>
          </div>

          <%= render "orders/shared_checkout_fields", f: f %>

          <%= f.submit "Confirm & Pay", class: "btn btn-success w-100 fw-bold py-2 shadow-sm" %>
        <% end %>

      <%# --- 2. CART CHECKOUT --- %>
      <% elsif @order.present? && @cart_items.present? %>
        <h4 class="fw-semibold text-secondary mb-3">Order Summary</h4>
        <div class="table-responsive mb-4">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th>Variant</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Subtotal</th>
                <th>Shipping</th>
              </tr>
            </thead>
            <tbody>
              <% @cart_items.each do |item| %>
                <% product = item[:product] %>
                <% variant = item[:variant] %>
                <% shipping_cost = item[:shipping] || 0 %>
                <tr>
                  <td><%= product.title %></td>
                  <td><%= variant ? "#{variant.name}: #{variant.value}" : "â€”" %></td>
                  <td><%= item[:quantity] %></td>
                  <td><%= display_price(item[:unit_price]) %></td>
                  <td><%= display_price(item[:subtotal]) %></td>
                  <td><%= display_price(shipping_cost) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <% subtotal = @cart_items.sum { |i| i[:subtotal] } %>
        <% shipping_total = @cart_items.sum { |i| i[:shipping] || 0 } %>
        <% grand_total = subtotal + shipping_total %>

        <div class="mb-4">
          <h5>Subtotal: <%= display_price(subtotal) %></h5>
          <h5>Shipping: <%= display_price(shipping_total) %></h5>
          <h4 class="text-success fw-bold">Grand Total: <%= display_price(grand_total) %></h4>
        </div>
        
        <%= form_with model: @order, local: true, html: { class: "checkout-form" } do |f| %>
          <%= render "orders/shared_checkout_fields", f: f %>
          <%= f.submit "Confirm & Pay", class: "btn btn-success w-100 fw-bold py-2 shadow-sm" %>
        <% end %>

      <% else %>
        <p class="text-muted fs-5">Your cart is empty.</p>
        <%= link_to "Back to Products", products_path, class: "btn btn-primary fw-semibold" %>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    
    // Helper function to set up payment toggles
    function setupPaymentToggle(mpesaRadioId, paypalRadioId, paystackRadioId, phoneFieldId) {
      const mpesaRadio   = document.getElementById(mpesaRadioId);
      const paypalRadio  = document.getElementById(paypalRadioId);
      const paystackRadio= document.getElementById(paystackRadioId);
      const phoneField   = document.getElementById(phoneFieldId);

      function togglePhoneField() {
        if (mpesaRadio && mpesaRadio.checked) {
          phoneField.style.display = "block";
        } else if (phoneField) {
          phoneField.style.display = "none";
        }
      }

      [mpesaRadio, paypalRadio, paystackRadio].forEach(radio => {
        if (radio) radio.addEventListener("change", togglePhoneField);
      });

      // Hide by default, then run toggle on page load
      if (phoneField) phoneField.style.display = "none";
      togglePhoneField();
    }

    // Helper function to set up country/region toggles
    function setupCountryToggle(countrySelectId, countyWrapperId, regionWrapperId) {
      const countrySelect = document.getElementById(countrySelectId);
      const countyWrapper = document.getElementById(countyWrapperId);
      const regionWrapper = document.getElementById(regionWrapperId);

      if (!countrySelect) return; // Exit if this form isn't on the page

      function toggleFields() {
        if (countrySelect.value === "Kenya") {
          countyWrapper.style.display = "block";
          regionWrapper.style.display = "none";
        } else {
          countyWrapper.style.display = "none";
          regionWrapper.style.display = "block";
        }
      }
      countrySelect.addEventListener("change", toggleFields);
      toggleFields(); // Run on page load
    }

    // Helper function to set up DHL rate fetching
    async function fetchRates(countrySelectId, cityFieldId, ratesBoxId) {
      const countrySelect = document.getElementById(countrySelectId);
      const cityField     = document.getElementById(cityFieldId);
      const ratesBox      = document.getElementById(ratesBoxId);

      if (!countrySelect || !cityField || !ratesBox) return; // Exit if elements aren't here

      async function getRates() {
        const country = countrySelect.value;
        const city    = cityField.value;
        if (!country || !city) return;

        ratesBox.innerHTML = "Fetching DHL rates...";
        try {
          const response = await fetch(`/shipping/rates?country=${country}&city=${city}`);
          const data = await response.json();
          if (data.error) {
            ratesBox.innerHTML = `<span class="text-danger">${data.error}</span>`;
          } else {
            let html = "<ul class='list-unstyled mb-0'>";
            (data.products || []).forEach(rate => {
              html += `<li><strong>${rate.productName}</strong>: ${rate.totalPrice[0].price} ${rate.totalPrice[0].currency}</li>`;
            });
            html += "</ul>";
            ratesBox.innerHTML = html;
          }
        } catch (error) {
          ratesBox.innerHTML = `<span class="text-danger">Error fetching rates.</span>`;
        }
      }
      
      countrySelect.addEventListener("change", getRates);
      cityField.addEventListener("blur", getRates);
    }

    // --- Initialize for PRODUCT form ---
    setupPaymentToggle("provider_mpesa_product", "provider_paypal_product", "provider_paystack_product", "mpesa_phone_field_product");
    setupCountryToggle("country-select-product", "county-wrapper-product", "region-wrapper-product");
    fetchRates("country-select-product", "city-field-product", "shipping-rates-product");

    // --- Initialize for CART form ---
    setupPaymentToggle("provider_mpesa_cart", "provider_paypal_cart", "provider_paystack_cart", "mpesa_phone_field_cart");
    setupCountryToggle("country-select-cart", "county-wrapper-cart", "region-wrapper-cart");
    fetchRates("country-select-cart", "city-field-cart", "shipping-rates-cart");

  });
</script>

<style>
  .checkout-form label { color: #444; }
  .checkout-form input, .checkout-form textarea, .checkout-form select {
    border-radius: 0.5rem;
  }
  .checkout-form input:focus, .checkout-form select:focus, .checkout-form textarea:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.15rem rgba(13,110,253,.25);
  }
  .card {
    border-radius: 1rem;
  }
  h4.fw-semibold {
    margin-top: 1rem;
  }
</style>