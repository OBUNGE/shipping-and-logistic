<div class="container py-5">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <div class="card-body p-5">

      <h1 class="fw-bold text-center mb-5 text-primary">ðŸ›’ Checkout</h1>

      <% if @product.present? %>
        <!-- SINGLE PRODUCT CHECKOUT -->
        <section class="mb-5">
          <h4 class="border-start border-4 border-primary ps-3 mb-3 fw-semibold">Product Summary</h4>
          <div class="p-3 bg-light rounded-3">
            <p><strong>Product:</strong> <%= @product.title %></p>
            <p><strong>Price per unit:</strong> <%= display_price(@product.price, user: current_user) %></p>
            <p><strong>Seller:</strong> <%= @product.seller.company_name.presence || @product.seller.name.presence || "Unknown Seller" %></p>
            <p><strong>Delivery:</strong> <%= @product.estimated_delivery_range.presence || "2â€“5 business days" %></p>
            <p><strong>Shipping:</strong> <%= display_price(@product.shipping_cost || 0, user: current_user) %></p>
          </div>
        </section>

        <%= form_with url: product_orders_path(@product), method: :post, local: true, data: { turbo: false }, class: "needs-validation" do |f| %>
          <% if @product.variants.any? %>
            <div class="mb-4">
              <%= f.label :variant_id, "Choose Variant", class: "form-label fw-semibold" %>
              <%= f.select :variant_id,
                    options_for_select(@product.variants.map { |v|
                      label = "#{v.name}: #{v.value}"
                      if v.price_modifier.present? && v.price_modifier != 0
                        label += " (+" + display_price(v.price_modifier, user: current_user) + ")"
                      end
                      [label, v.id]
                    }),
                    { prompt: "Select a variant" },
                    class: "form-select form-select-lg shadow-sm rounded-pill",
                    required: true %>
            </div>
          <% end %>

          <div class="mb-4">
            <%= f.label :quantity, "Quantity", class: "form-label fw-semibold" %>
            <%= f.number_field :quantity, value: 1, min: 1, class: "form-control shadow-sm rounded-pill text-center", required: true %>
          </div>

          <%= render "orders/shared_checkout_fields", f: f %>

          <!-- Total Display -->
          <div class="mb-4">
            <p class="fs-5 fw-semibold text-success">Estimated Total: <%= display_price(@product.price + (@product.shipping_cost || 0), user: current_user) %></p>
          </div>

          <%= f.submit "Confirm & Pay", class: "btn btn-gradient w-100 py-3 fw-bold rounded-pill" %>
        <% end %>

      <% elsif @cart_items.present? %>
        <!-- CART CHECKOUT -->
        <section class="mb-5">
          <h4 class="border-start border-4 border-primary ps-3 mb-3 fw-semibold">Cart Summary</h4>
          <% total = 0 %>
          <% @cart_items.each do |item| %>
            <% item_total = item[:subtotal] + item[:shipping] %>
            <% total += item_total %>
            <div class="p-3 bg-light rounded-3 mb-3">
              <p><strong>Product:</strong> <%= item[:product].title %></p>
              <p><strong>Variant:</strong> <%= item[:variant] ? "#{item[:variant].name}: #{item[:variant].value}" : "â€”" %></p>
              <p><strong>Quantity:</strong> <%= item[:quantity] %></p>
              <p><strong>Unit Price:</strong> <%= display_price(item[:unit_price], user: current_user) %></p>
              <p><strong>Subtotal:</strong> <%= display_price(item[:subtotal], user: current_user) %></p>
              <p><strong>Shipping:</strong> <%= display_price(item[:shipping], user: current_user) %></p>
              <p><strong>Item Total:</strong> <%= display_price(item_total, user: current_user) %></p>
            </div>
          <% end %>

          <!-- Total Display -->
          <div class="mb-4">
            <p class="fs-5 fw-semibold text-success">Estimated Total: <%= display_price(total, user: current_user) %></p>
          </div>
        </section>

        <%= form_with url: orders_path, method: :post, local: true, data: { turbo: false }, class: "needs-validation" do |f| %>
          <%= render "orders/shared_checkout_fields", f: f %>
          <%= f.submit "Confirm & Pay", class: "btn btn-gradient w-100 py-3 fw-bold rounded-pill" %>
        <% end %>

      <% else %>
        <!-- EMPTY STATE -->
        <p class="text-center text-muted fs-5 mb-4">Your cart is empty.</p>
        <div class="text-center">
          <%= link_to "Back to Products", products_path, class: "btn btn-outline-primary rounded-pill px-4 py-2" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
  .btn-gradient {
    background: linear-gradient(135deg, #0d6efd, #198754);
    color: #fff;
    border: none;
    transition: 0.3s ease;
  }
  .btn-gradient:hover {
    background: linear-gradient(135deg, #198754, #0d6efd);
    transform: scale(1.02);
  }

  .form-label {
    font-weight: 600;
  }

  .form-control, .form-select {
    border: 1px solid #ddd;
  }

  textarea.form-control {
    border-radius: 1rem;
  }

  .card-body {
    background-color: #fff;
  }

  .border-start {
    border-radius: 3px;
  }

  .fw-semibold {
    font-weight: 600;
  }

  .text-primary {
    color: #0d6efd !important;
  }
</style>

<!-- Payment toggle script -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const mpesa = document.getElementById("provider_mpesa");
    const paypal = document.getElementById("provider_paypal");
    const paystack = document.getElementById("provider_paystack");
    const phoneField = document.getElementById("mpesa_phone_field");

    function togglePhoneField() {
      phoneField.style.display = mpesa.checked ? "block" : "none";
    }

    [mpesa, paypal, paystack].forEach(el => el?.addEventListener("change", togglePhoneField));
    togglePhoneField();
  });
</script>
