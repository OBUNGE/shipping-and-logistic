<div id="<%= dom_id(f.object) %>" 
     class="border p-3 mb-2 bg-light rounded variant-block" 
     data-saved-value="<%= f.object.value %>">

  <div class="row g-2">
    <!-- Variant Type -->
    <div class="col-md-4">
      <%= f.label :name, "Type", class: "form-label small" %>
      <%= f.select :name,
            ["Color","Size","Storage","Material","Packaging"],
            { selected: f.object.name },
            class: "form-select form-select-sm variant-type",
            required: true %>
    </div>

    <!-- Variant Value -->
    <div class="col-md-4">
      <%= f.label :value, "Option", class: "form-label small" %>
      <!-- Options populated by JS, but saved value is stored in data-current -->
      <%= f.select :value,
            [],
            {},
            class: "form-select form-select-sm variant-value",
            required: true,
            data: { current: f.object.value } %>
    </div>

    <!-- Price Modifier -->
    <div class="col-md-3">
      <%= f.label :price_modifier, "Price Modifier", class: "form-label small" %>
      <%= f.number_field :price_modifier,
            step: 0.01,
            placeholder: "e.g. 50.00",
            class: "form-control form-control-sm" %>
    </div>

    <!-- Delete Variant -->
    <div class="col-md-1 d-flex align-items-end">
      <%= f.hidden_field :_destroy, class: "destroy-flag" %>

      <% if f.object.persisted? %>
        <!-- âœ… Turbo delete for persisted variant -->
        <%= button_to "Delete",
              remove_variant_product_path(@product, id: f.object.id),
              method: :delete,
              form: { data: { turbo_confirm: "Remove this variant?" } },
              class: "btn btn-sm btn-outline-danger" %>
      <% else %>
        <!-- For new unsaved variants, JS delete sets _destroy -->
        <button type="button" class="btn btn-sm btn-outline-danger delete-variant">Delete</button>
      <% end %>
    </div>
  </div>

  <!-- ðŸŽ¨ Variant Images (only for Color) -->
  <div class="mt-2 color-image-actions <%= 'd-none' unless f.object.name == 'Color' %>">
    <%# Ensure at least one nested image slot exists for new Color variants %>
    <% if f.object.name == "Color" && f.object.variant_images.empty? %>
      <%= f.object.variant_images.build %>
    <% end %>

    <%= f.fields_for :variant_images do |image_fields| %>
      <%= render "variant_image_fields", f: image_fields %>
    <% end %>

    <% if @product.persisted? && f.object.persisted? %>
      <%= button_to "âž• Add color image",
            add_variant_image_product_path(@product, id: f.object.id),
            method: :post,
            data: { turbo_stream: true },
            class: "btn btn-sm btn-outline-secondary" %>
    <% else %>
      <!-- For new unsaved variants, use JS cloning -->
      <button type="button"
              class="btn btn-sm btn-outline-secondary add-variant-image-btn">
        âž• Add color image
      </button>
    <% end %>
  </div>
</div>

<!-- Hidden template for new variant images -->
<div id="variant-image-template" style="display:none;">
  <div class="border p-2 mb-2 bg-light rounded variant-image-block">
    <input type="file"
           name="product[variants_attributes][NEW_RECORD][variant_images_attributes][NEW_IMAGE][image]"
           class="form-control form-control-sm variant-image-input"
           accept="image/*"
           onchange="previewVariantImage(event)" />

    <input type="hidden"
           name="product[variants_attributes][NEW_RECORD][variant_images_attributes][NEW_IMAGE][_destroy]"
           class="destroy-flag" />

    <button type="button" class="btn btn-sm btn-outline-danger delete-variant-image">Delete</button>
  </div>
</div>
