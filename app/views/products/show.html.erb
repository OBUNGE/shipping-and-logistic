<div class="container py-4">
  <div class="row g-5">

    <!-- ðŸ–¼ï¸ Product Image Section -->
<div class="col-lg-6">
  <% if @product.image_url.present? || @product.gallery_image_urls.any? || @product.variants.joins(:variant_images).exists? %>
    <div class="border rounded-4 overflow-hidden bg-white shadow-sm p-3">
      <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner rounded-4">
          <% slide_index = 0 %>

          <% if @product.image_url.present? %>
            <div class="carousel-item active">
              <%= image_tag @product.image_url, class: "d-block w-100 rounded-3", style: "max-height: 600px; object-fit: contain;" %>
            </div>
            <% slide_index += 1 %>
          <% end %>

          <% @product.gallery_image_urls.each_with_index do |url, index| %>
            <% next unless url.is_a?(String) && url.present? %>
            <div class="carousel-item <%= 'active' if @product.image_url.blank? && index == 0 %>">
              <%= image_tag url, class: "d-block w-100 rounded-3", style: "max-height: 600px; object-fit: contain;" %>
            </div>
            <% slide_index += 1 %>
          <% end %>

          <% @product.variants.includes(:variant_images).each do |variant| %>
            <% variant.variant_images.each_with_index do |img, index| %>
              <% next if img.image_url.blank? %>
              <div class="carousel-item <%= 'active' if @product.image_url.blank? && @product.gallery_image_urls.blank? && index == 0 %>">
                <%= image_tag img.image_url, class: "d-block w-100 rounded-3", style: "max-height: 600px; object-fit: contain;" %>
                <!-- Caption showing which variant this image belongs to -->
                <div class="carousel-caption bg-dark bg-opacity-50 rounded-3 p-2">
                  <small><%= variant.name %>: <%= variant.value %></small>
                </div>
              </div>
              <% slide_index += 1 %>
            <% end %>
          <% end %>
        </div>

        <!-- Carousel controls -->
        <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon bg-dark rounded-circle p-2"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon bg-dark rounded-circle p-2"></span>
        </button>

        <!-- Dot indicators (mobile only) -->
        <div class="carousel-indicators d-md-none">
          <% total_slides = slide_index %>
          <% total_slides.times do |i| %>
            <button type="button"
                    data-bs-target="#productCarousel"
                    data-bs-slide-to="<%= i %>"
                    class="<%= 'active' if i == 0 %>"
                    aria-current="<%= 'true' if i == 0 %>"
                    aria-label="Slide <%= i+1 %>"></button>
          <% end %>
        </div>
      </div>

      <!-- Thumbnails: horizontal scroll bar (desktop/tablet only) -->
      <div class="position-relative d-none d-md-block mt-3">
        <!-- Scroll arrows -->
        <button class="thumb-scroll-btn left btn btn-light btn-sm shadow-sm" type="button">â€¹</button>
        <button class="thumb-scroll-btn right btn btn-light btn-sm shadow-sm" type="button">â€º</button>

        <div class="thumbnail-scroll d-flex flex-row overflow-auto gap-2 p-2 border rounded-3 bg-light">
          <% thumb_index = 0 %>

          <% if @product.image_url.present? %>
            <%= image_tag @product.image_url,
                  class: "img-thumbnail shadow-sm border rounded-3 hover-scale active-thumb",
                  style: "width: 75px; height: 75px; object-fit: cover; cursor: pointer; flex: 0 0 auto;",
                  data: { bs_target: "#productCarousel", bs_slide_to: thumb_index } %>
            <% thumb_index += 1 %>
          <% end %>

          <% @product.gallery_image_urls.each do |url| %>
            <% next unless url.is_a?(String) && url.present? %>
            <%= image_tag url,
                  class: "img-thumbnail shadow-sm border rounded-3 hover-scale",
                  style: "width: 75px; height: 75px; object-fit: cover; cursor: pointer; flex: 0 0 auto;",
                  data: { bs_target: "#productCarousel", bs_slide_to: thumb_index } %>
            <% thumb_index += 1 %>
          <% end %>

          <% @product.variants.includes(:variant_images).each do |variant| %>
            <% variant.variant_images.each do |img| %>
              <% next if img.image_url.blank? || img.image_url.start_with?("blob:") %>
              <div class="text-center flex-shrink-0">
                <%= image_tag img.image_url,
                      class: "img-thumbnail border rounded-3 hover-scale",
                      style: "width: 75px; height: 75px; object-fit: cover; cursor: pointer; flex: 0 0 auto;",
                      data: { bs_target: "#productCarousel", bs_slide_to: thumb_index } %>
                <small class="d-block text-muted"><%= variant.value %></small>
              </div>
              <% thumb_index += 1 %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <%= image_tag asset_path("placeholder.jpg"), class: "img-fluid rounded-4 shadow-sm border", alt: "No product image available" %>
  <% end %>
</div>

<!-- ðŸ›’ Product Info -->
<div class="col-lg-6">
  <h1 class="fw-bold mb-2 lh-1"><%= @product.title %></h1>

  <div class="mb-3 text-muted small">
    <span class="fw-semibold"><%= @product.seller_name %></span> |
    <%= render_stars(@product.average_rating) %> (<%= @product.average_rating %>/5)
    <% if @product.average_rating >= 4.5 %>
      <span class="badge bg-success ms-2">Highly Rated</span>
    <% end %>
  </div>

  <!-- âœ… Price block -->
  <div class="border-start border-3 border-primary ps-3 mb-4">
    <% price_in_kes = ExchangeRateService.convert(@product.price, from: @product.currency, to: "KES") %>
    <h2 class="fw-bold text-primary mb-0"><%= number_to_currency(price_in_kes, unit: "KES ") %></h2>
    <% usd_price = ExchangeRateService.convert(price_in_kes, from: "KES", to: "USD") %>
    <small class="text-muted">â‰ˆ <%= number_to_currency(usd_price, unit: "USD ") %></small>

    <% if @product.discount&.active? %>
      <% discounted_kes = ExchangeRateService.convert(@product.discounted_price, from: @product.currency, to: "KES") %>
      <small class="text-success d-block">
        <%= @product.discount.percentage %>% OFF â€” Now: <%= number_to_currency(discounted_kes, unit: "KES ") %>
      </small>
    <% end %>
  </div>

  <!-- âœ… Purchase Options -->
  <div class="rounded-4 bg-light p-4 shadow-sm mb-4">
    <h5 class="fw-semibold mb-3">Purchase Options</h5>

    <% if @order.present? %>
      <% latest_payment = @order.payments.last %>
      <% if latest_payment.nil? %>
        <%= button_to "Pay Now", order_payment_path(@order), method: :post, class: "btn btn-success w-100 py-2 fw-semibold" %>
      <% else %>
        <p><strong>Order Status:</strong> <%= @order.status.capitalize %></p>
        <p><strong>Payment Status:</strong> <%= latest_payment.status.capitalize %></p>
      <% end %>
    <% else %>
      <!-- âœ… Buy Now â†’ Single product checkout -->
      <%= form_with url: new_order_path, method: :get, local: true do |f| %>
        <%= f.hidden_field :product_id, value: @product.id %>
        <%= f.hidden_field :quantity, value: @product.min_order || 1 %>
        <%= f.submit "Buy Now", class: "btn btn-gradient w-100 mb-3 fw-semibold py-2" %>
      <% end %>
    <% end %>

<!-- âœ… Add to Cart form -->
<%= form_with url: add_cart_path, method: :post, local: true, data: { turbo: false } do %>
  <!-- Product ID -->
  <%= hidden_field_tag :product_id, @product.id %>

  <% if @product.variants.any? %>
    <div class="mb-3">
      <label class="form-label small fw-semibold">Choose Variants</label>

      <% @product.variants.group_by(&:name).each do |name, variants| %>
        <h6 class="fw-semibold mt-3"><%= name %></h6>
        <div class="d-flex flex-wrap gap-2">
          <% variants.each do |variant| %>
            <label class="variant-option">
              <!-- âœ… Force raw name so Rails doesnâ€™t rewrite -->
              <%= radio_button_tag "variants[#{name}]", variant.id, false, class: "d-none" %>

              <% if variant.primary_image_url.present? %>
                <!-- Circular thumbnail if Supabase image URL exists -->
                <%= image_tag variant.primary_image_url, class: "variant-thumb" %>
              <% else %>
                <!-- Text pill if no image -->
                <span class="variant-pill"><%= variant.value %></span>
              <% end %>
            </label>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Quantity control -->
  <div class="mb-3">
    <%= label_tag :quantity, "Quantity", class: "form-label small fw-semibold" %>
    <div class="input-group input-group-sm" style="width: 120px;">
      <button type="button" class="btn btn-outline-secondary qty-minus" data-target="product_quantity">âˆ’</button>
      <%= number_field_tag :quantity,
            @product.min_order || 1,
            min: @product.min_order || 1,
            class: "form-control text-center variant-qty",
            id: "product_quantity",
            data: { price: (@product.discount&.active? ? @product.discounted_price : @product.price) } %>
      <button type="button" class="btn btn-outline-secondary qty-plus" data-target="product_quantity">+</button>
    </div>
  </div>

  <!-- Live subtotal -->
  <div id="subtotal" class="fw-semibold text-primary mt-2"></div>

  <!-- Submit -->
  <%= submit_tag "Add to Cart", class: "btn btn-outline-primary w-100 fw-semibold py-2 mt-2" %>
<% end %>

  <!-- âœ… Product Meta -->
  <div class="small text-muted">
    <div class="row">
      <div class="col-6"><strong>Stock:</strong> <%= @product.stock %></div>
      <div class="col-6"><strong>Min Order:</strong> <%= @product.min_order %></div>
      <div class="col-6">
        <strong>Shipping:</strong>
        <% shipping_kes = ExchangeRateService.convert(@product.shipping_cost || 0, from: @product.currency, to: "KES") %>
        <%= number_to_currency(shipping_kes, unit: "KES ") %>
      </div>
      <div class="col-6"><strong>Delivery:</strong> <%= @product.delivery_estimate %></div>
    </div>
  </div>

  <% if user_signed_in? && current_user.seller? && current_user == @product.seller %>
    <div class="mt-4 border-top pt-3">
      <%= link_to "Edit Product", edit_product_path(@product), class: "btn btn-outline-secondary btn-sm me-2" %>
      <%= button_to "Delete", product_path(@product), method: :delete, data: { confirm: "Are you sure?" }, class: "btn btn-outline-danger btn-sm" %>
    </div>
  <% end %>
</div>

  <!-- ðŸ“œ Product Description -->
  <div class="mt-5 border rounded-4 p-4 bg-white shadow-sm">
    <h3 class="fw-semibold mb-3">Product Description</h3>
    <div class="text-muted"><%= @product.description %></div>
  </div>

<!-- ðŸŒŸ Reviews -->
<div class="mt-5 border rounded-4 p-4 bg-white shadow-sm">
  <h3 class="fw-semibold mb-3">Customer Reviews</h3>

  <% if @product.reviews.any? %>
    <div class="mb-3">
      <%= render_stars(@product.average_rating) %>
      <span class="text-muted">(<%= @product.average_rating %>/5 from <%= @product.reviews.count %> reviews)</span>
    </div>

    <% @reviews.each do |review| %>
      <div class="border rounded-3 p-3 mb-3 bg-light">
        <strong><%= review.user.name %></strong>
        <%= render_stars(review.rating) %> â€” <%= review.comment %>
        <div class="text-muted small"><%= review.created_at.strftime("%b %d, %Y") %></div>

        <div class="mt-2">
          <span class="small text-muted"><%= review.helpful_count %> people found this helpful</span>
          <%= button_to "Helpful",
      vote_product_review_path(@product, review),
      method: :post,
      class: "btn btn-sm btn-outline-success ms-2",
      data: { turbo_stream: true } %>

        </div>

        <% if review.user == current_user %>
          <div class="mt-2">
            <%= link_to "Edit", edit_product_review_path(@product, review), class: "btn btn-sm btn-outline-secondary" %>
            <%= button_to "Delete", product_review_path(@product, review), method: :delete, class: "btn btn-sm btn-danger" %>
          </div>
        <% end %>
      </div>
    <% end %>

    <%= paginate @reviews %>
  <% else %>
    <p class="text-muted">No reviews yet. Be the first!</p>
  <% end %>

  <!-- Review form -->
<%= render partial: "reviews/form", locals: { product: @product, review: Review.new } %>


  <!-- ðŸ§© Related Products -->
  <div class="mt-5 border rounded-4 p-4 bg-white shadow-sm">
    <h3 class="fw-semibold mb-3">Related Products</h3>
    <div class="row g-3">
      <% Product.where.not(id: @product.id).limit(4).each do |related| %>
        <div class="col-md-3">
          <div class="card h-100 border-0 shadow-sm hover-shadow rounded-4 overflow-hidden">
            <%= image_tag(related.image_url.presence || related.gallery_image_urls.first || asset_path("placeholder.jpg"), class: "card-img-top", style: "height: 200px; object-fit: cover;") %>
            <div class="card-body">
              <h6 class="fw-semibold text-truncate"><%= related.title %></h6>
              <p class="text-primary fw-bold small mb-2">KES <%= related.price %></p>
              <%= link_to "View", product_path(related), class: "btn btn-sm btn-outline-primary w-100 fw-semibold" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="text-end mt-4">
    <%= link_to "â† Back to Products", products_path, class: "btn btn-link fw-semibold" %>
  </div>
</div>

<style>
.btn-gradient {
  background: linear-gradient(90deg, #007bff, #00c6ff);
  color: #fff !important;
  border: none;
  transition: all 0.3s ease-in-out;
}
.btn-gradient:hover {
  background: linear-gradient(90deg, #0056b3, #0099cc);
  transform: translateY(-1px);
}
.hover-scale:hover {
  transform: scale(1.05);
  transition: 0.3s ease-in-out;
}
.hover-shadow:hover {
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  transition: all 0.3s ease-in-out;
}
</style>

<script>
document.addEventListener("turbo:load", () => {
  // â­ Star Rating Logic (unchanged)
  const stars = document.querySelectorAll("#star-rating .star");
  const ratingInput = document.getElementById("review_rating");

  if (stars.length && ratingInput) {
    stars.forEach(star => {
      star.addEventListener("click", () => {
        const value = star.getAttribute("data-value");
        ratingInput.value = value;

        stars.forEach(s => {
          s.classList.remove("selected");
          if (parseInt(s.dataset.value) <= parseInt(value)) {
            s.classList.add("selected");
          }
        });
      });
    });
  }

  // ðŸŽ¨ Variant Dropdown Logic
  const carousel = document.getElementById("productCarousel");
  const variantDropdown = document.querySelector(".variant-dropdown");

  if (carousel && variantDropdown) {
    const bsCarousel = bootstrap.Carousel.getOrCreateInstance(carousel);

    variantDropdown.addEventListener("change", (e) => {
      const variantId = e.target.value;
      const target = carousel.querySelector(`.carousel-item img[data-variant-id="${variantId}"]`);
      if (target) {
        const index = [...carousel.querySelectorAll(".carousel-item")]
          .indexOf(target.closest(".carousel-item"));
        bsCarousel.to(index);
      }
    });
  }

  // Thumbnail click â†’ update dropdown + carousel
  document.querySelectorAll(".variant-thumb").forEach(img => {
    img.addEventListener("click", (e) => {
      const variantId = e.target.dataset.variantId;
      const dropdown = document.querySelector(".variant-dropdown");
      if (variantId && dropdown) {
        dropdown.value = variantId;
        dropdown.dispatchEvent(new Event("change", { bubbles: true }));
      }
    });
  });
});
</script>
