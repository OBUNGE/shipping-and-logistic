<%= form_with model: @product, local: true, html: { class: "p-3", multipart: true } do |form| %>
  <% if @product.errors.any? %>
    <div class="alert alert-danger small">
      <strong><%= pluralize(@product.errors.count, "error") %>:</strong>
      <ul class="mb-0">
        <% @product.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- ðŸ“ Basic Info -->
  <div class="row g-2 mb-3">
    <div class="col-md-6">
      <%= form.label :title, class: "form-label small" %>
      <%= form.text_field :title, class: "form-control form-control-sm", placeholder: "e.g. Organic Honey 500ml", required: true %>
    </div>
    <div class="col-md-6">
      <%= form.label :min_order, "Minimum Order", class: "form-label small" %>
      <%= form.number_field :min_order, min: 1, class: "form-control form-control-sm", placeholder: "e.g. 5", required: true %>
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :description, class: "form-label small" %>
    <%= form.text_area :description, class: "form-control form-control-sm", rows: 3, placeholder: "Describe the product", required: true %>
  </div>
<!-- ðŸ·ï¸ Category -->
<div class="mb-3">
  <%= form.label :category_id, "Category", class: "form-label small" %>
  <%= form.collection_select :category_id, Category.where(parent_id: nil), :id, :name,
        { prompt: "Select a category" },
        { class: "form-select form-select-sm", id: "category-select", required: true } %>
</div>

<!-- ðŸ·ï¸ Subcategory -->
<div class="mb-3">
  <%= form.label :subcategory_id, "Subcategory", class: "form-label small" %>

  <%= form.select :subcategory_id,
        @product.category.present? ? @product.category.subcategories.pluck(:name, :id) : [],
        { prompt: "Select a subcategory" },
        { class: "form-select form-select-sm", id: "subcategory-select" } %>
</div>


<!-- ðŸ’° Pricing -->
<div class="row g-2 mb-3">
  <div class="col-md-6">
    <%= form.label :price, "Base Price", class: "form-label small" %>
    <%= form.number_field :price,
          step: 0.01,
          class: "form-control form-control-sm",
          id: "product_price",
          placeholder: "e.g. 120.00",
          required: true %>
    <small class="text-muted">
      Stored in USD â€” buyers will see <%= display_price(120, user: current_user) %> approx.
    </small>
  </div>

  <div class="col-md-6">
    <%= form.label :shipping_cost, "Shipping Cost", class: "form-label small" %>
    <%= form.number_field :shipping_cost,
          step: 0.01,
          class: "form-control form-control-sm",
          id: "product_shipping_cost",
          placeholder: "e.g. 300.00" %>
    <small class="text-muted">
      Stored in USD â€” buyers will see <%= display_price(300, user: current_user) %> approx.
    </small>
  </div>
</div>

<p class="text-primary small mb-3">
  ðŸ’µ Total Cost: 
  <span id="total-cost">
    <%= display_price((@product.price || 0) + (@product.shipping_cost || 0), user: current_user) %>
  </span>
</p>

  <!-- ðŸ“¦ Stock -->
  <div class="row g-2 mb-3">
    <div class="col-md-6">
      <%= form.label :stock, class: "form-label small" %>
      <%= form.number_field :stock, min: 0, class: "form-control form-control-sm", placeholder: "e.g. 200", required: true %>
    </div>
    <div class="col-md-6">
      <%= form.label :estimated_delivery_range, "Estimated Delivery", class: "form-label small" %>
      <%= form.text_field :estimated_delivery_range, class: "form-control form-control-sm", placeholder: "e.g. 2â€“5 days" %>
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :return_policy, class: "form-label small" %>
    <%= form.text_area :return_policy, class: "form-control form-control-sm", rows: 2, placeholder: "e.g. Returns accepted within 7 days" %>
  </div>

<!-- ðŸ–¼ï¸ Main Product Image -->
<div class="mb-3">
  <%= form.label :image, "Main Product Image", class: "form-label small" %>

  <% if @product.persisted? && @product.image.attached? && @product.image.representable? %>
    <div class="mb-2">
      <%= image_tag @product.image.variant(resize_to_limit: [600, 400]),
                    class: "img-fluid rounded shadow-sm",
                    style: "max-height: 250px;" %>
    </div>
  <% end %>

  <%= form.file_field :image, class: "form-control form-control-sm", accept: "image/*", onchange: "previewMainImage(event)" %>
  <img id="main-image-preview" class="img-fluid mt-2 rounded shadow-sm" style="max-height: 250px;" />
</div>

<!-- ðŸ–¼ï¸ Gallery Images -->
<div class="mb-3">
  <%= form.label :gallery_images, "Gallery Images", class: "form-label small" %>

  <% if @product.persisted? %>
    <div class="row g-2 mb-2">
      <% @product.gallery_images.each do |img| %>
        <% if img.representable? %>
          <div class="col-4 text-center">
            <%= image_tag img.variant(resize_to_limit: [300, 200]),
                          class: "img-fluid rounded shadow-sm mb-1" %>
            <%= link_to "Remove",
                        product_remove_gallery_image_path(product_id: @product.id, image_id: img.id),
                        method: :delete,
                        data: { confirm: "Are you sure?" },
                        class: "btn btn-sm btn-outline-danger" %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <div id="gallery-inputs">
    <%= form.file_field :gallery_images, multiple: true, class: "form-control form-control-sm mb-2", accept: "image/*", onchange: "previewGalleryImages(event)" %>
  </div>

  <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addGalleryInput()">âž• Add More Images</button>
  <div id="gallery-preview" class="row mt-2 sortable-preview"></div>
</div>

<!-- ðŸ”€ Variants -->
<div id="variant-fields">
  <%= form.fields_for :variants do |variant_fields| %>
    <div class="border p-3 mb-2 bg-light rounded variant-block">
      <div class="row g-2">
        <div class="col-md-4">
          <%= variant_fields.label :name, "Type", class: "form-label small" %>
          <%= variant_fields.select :name, ["Size", "Color", "Material", "Storage", "Packaging"], {}, class: "form-select form-select-sm variant-type", required: true %>
        </div>
        <div class="col-md-4">
          <%= variant_fields.label :value, "Option", class: "form-label small" %>
          <%= variant_fields.select :value, [], {}, class: "form-select form-select-sm variant-value", required: true %>
        </div>
        <div class="col-md-3">
          <%= variant_fields.label :price_modifier, "Price Modifier", class: "form-label small" %>
          <%= variant_fields.number_field :price_modifier, step: 0.01, placeholder: "e.g. 50.00", class: "form-control form-control-sm" %>
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button type="button" class="btn btn-sm btn-outline-danger delete-variant">Delete</button>
        </div>
      </div>

   <!-- ðŸŽ¨ Variant Images (only for Color) -->
<div class="mt-2 color-image-actions <%= 'd-none' unless variant_fields.object.name == 'Color' %>">
  <%= variant_fields.fields_for :variant_images do |image_fields| %>
    <div class="border p-2 mb-2 bg-light rounded variant-image-block">
      <% if image_fields.object.image.attached? && image_fields.object.image.representable? %>
        <%= image_tag image_fields.object.image.variant(resize_to_limit: [150, 150]), class: "img-thumbnail mb-1" %>
      <% end %>
      <%= image_fields.file_field :image, class: "form-control form-control-sm", accept: "image/*" %>
      <%= image_fields.hidden_field :_destroy, class: "destroy-flag" %>
      <button type="button" class="btn btn-sm btn-outline-danger delete-variant-image">Delete</button>
    </div>
  <% end %>

  <button type="button" class="btn btn-sm btn-outline-secondary add-variant-image-btn">
     Add color image
  </button>
</div>

    </div>
  <% end %>
</div>

<button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addFields('variant-fields')">âž• Add Variant</button>

<!-- ðŸ”§ Hidden Variant Template -->
<div id="variant-template" style="display: none;">
  <div class="border p-3 mb-2 bg-light rounded variant-block">
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label small">Type</label>
        <select name="product[variants_attributes][NEW_RECORD][name]" class="form-select form-select-sm variant-type">
          <option value="">Select Type</option>
          <% ["Size", "Color", "Material", "Storage", "Packaging"].each do |type| %>
            <option value="<%= type %>"><%= type %></option>
          <% end %>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label small">Option</label>
        <select name="product[variants_attributes][NEW_RECORD][value]" class="form-select form-select-sm variant-value"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label small">Price Modifier</label>
        <input type="number" step="0.01" name="product[variants_attributes][NEW_RECORD][price_modifier]" class="form-control form-control-sm" placeholder="e.g. 50.00" />
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button type="button" class="btn btn-sm btn-outline-danger delete-variant">Delete</button>
      </div>
    </div>

    <!-- ðŸŽ¨ Variant Images -->
    <div class="mt-2 d-none color-image-actions">
      <button type="button" class="btn btn-sm btn-outline-secondary add-variant-image-btn">
         Add color image
      </button>
    </div>
  </div>
</div>




<!-- ðŸ¬ Inventory -->
<div class="mb-4">
  <label class="form-label small fw-semibold">Inventory</label>
  <div id="inventory-fields">
    <%= form.fields_for :inventories do |inv_fields| %>
      <div class="border p-2 mb-2 bg-light rounded">
        <%= inv_fields.text_field :location, placeholder: "e.g. Nairobi Warehouse", class: "form-control form-control-sm mb-1" %>
        <%= inv_fields.number_field :quantity, min: 0, class: "form-control form-control-sm mb-1" %>
        <div class="form-check">
          <%= inv_fields.check_box :_destroy, class: "form-check-input" %>
          <%= inv_fields.label :_destroy, "Remove", class: "form-check-label small" %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="mt-3">
    <%= form.label :inventory_csv, "Upload CSV", class: "form-label small fw-semibold" %>
    <%= form.file_field :inventory_csv, class: "form-control form-control-sm", accept: ".csv" %>
  </div>

  <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addFields('inventory-fields')">âž• Add Inventory</button>
</div>

<!-- âœ… Submit (inside the form) -->
<div class="mt-3">
  <%= form.submit(@product.persisted? ? "Update Product" : "Save Product",
                  class: "btn btn-primary w-100 fw-semibold") %>
</div>
<% end %> 
<!-- closes form_with -->

<!-- ðŸ’¸ Discount Section (outside the form) -->
<% if @product.persisted? %>
  <hr>
  <h5 class="fw-semibold mb-3">ðŸ’¸ Discount</h5>

  <% if @product.discount.present? %>
    <div class="border p-3 mb-3 bg-light rounded">
      <p class="mb-1">
        <strong><%= @product.discount.percentage %>% off</strong>
        â€” expires on <%= @product.discount.expires_at.strftime("%b %d, %Y") %>
      </p>
      <div class="d-flex gap-2 mt-2">
        <%= link_to "Edit Discount",
                    edit_discount_path(@product.discount),
                    class: "btn btn-sm btn-outline-primary" %>
        <%= link_to "Remove Discount",
                    discount_path(@product.discount),
                    method: :delete,
                    data: { confirm: "Are you sure you want to remove this discount?" },
                    class: "btn btn-sm btn-outline-danger" %>
      </div>
    </div>
  <% else %>
    <div class="border p-3 mb-3 bg-light rounded">
      <p class="small text-muted mb-2">
        No discount currently applied to this product.
      </p>
      <%= link_to "Add Discount",
                  new_discount_path(product_id: @product.id),
                  class: "btn btn-sm btn-success" %>
    </div>
  <% end %>
<% end %>


<script>
  function addGalleryInput() {
    const container = document.getElementById("gallery-inputs");
    const input = document.createElement("input");
    input.type = "file";
    input.name = "product[gallery_images][]";
    input.accept = "image/*";
    input.className = "form-control form-control-sm mb-2";
    container.appendChild(input);
  }

  document.addEventListener("turbo:load", () => {
    const categorySelect = document.getElementById("category-select");
    const subcategorySelect = document.getElementById("subcategory-select");

    if (categorySelect && subcategorySelect) {
      categorySelect.addEventListener("change", (e) => {
        const categoryId = e.target.value;

        fetch(`/categories/${categoryId}/subcategories.json`)
          .then(res => res.json())
          .then(data => {
            subcategorySelect.innerHTML = "<option value=''>Select a subcategory</option>";
            data.forEach(sub => {
              subcategorySelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
            });
          });
      });
    }
  });
</script>
