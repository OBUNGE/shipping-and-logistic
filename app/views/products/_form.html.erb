<%= form_with model: @product,
              url: @product.persisted? ? product_path(@product) : products_path,
              local: true,
              html: { class: "p-3", multipart: true } do |form| %>

  <% if @product.errors.any? %>
    <div class="alert alert-danger small">
      <strong><%= pluralize(@product.errors.count, "error") %>:</strong>
      <ul class="mb-0">
        <% @product.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- BASIC FIELDS (unchanged) -->
  <div class="row g-2 mb-3">
    <div class="col-md-6">
      <%= form.label :title, class: "form-label small" %>
      <%= form.text_field :title, class: "form-control form-control-sm", placeholder: "e.g. Organic Honey 500ml", required: true %>
    </div>
    <div class="col-md-6">
      <%= form.label :min_order, "Minimum Order", class: "form-label small" %>
      <%= form.number_field :min_order, min: 1, class: "form-control form-control-sm", placeholder: "e.g. 5", required: true %>
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :description, class: "form-label small" %>
    <%= form.text_area :description, class: "form-control form-control-sm", rows: 3, placeholder: "Describe the product", required: true %>
  </div>

  <!-- Category & Subcategory (unchanged) -->
  <div class="mb-3">
    <%= form.label :category_id, "Category", class: "form-label small" %>
    <%= form.collection_select :category_id, Category.where(parent_id: nil), :id, :name,
          { prompt: "Select a category" },
          { class: "form-select form-select-sm", id: "category-select", required: true } %>
  </div>

  <div class="mb-3">
    <%= form.label :subcategory_id, "Subcategory", class: "form-label small" %>
    <%= form.select :subcategory_id,
          @product.category.present? ? @product.category.subcategories.pluck(:name, :id) : [],
          { prompt: "Select a subcategory", selected: @product.subcategory_id },
          { class: "form-select form-select-sm", id: "subcategory-select", data: { current: @product.subcategory_id } } %>
  </div>

  <!-- Pricing, Stock etc (unchanged) -->
  <div class="row g-2 mb-3">
    <div class="col-md-6">
      <%= form.label :price, "Base Price (KES)", class: "form-label small" %>
      <%= form.number_field :price, step: 1, class: "form-control form-control-sm", id: "product_price", placeholder: "e.g. 1200", required: true %>
    </div>
    <div class="col-md-6">
      <%= form.label :shipping_cost, "Shipping Cost (KES)", class: "form-label small" %>
      <%= form.number_field :shipping_cost, step: 1, class: "form-control form-control-sm", id: "product_shipping_cost", placeholder: "e.g. 300" %>
    </div>
  </div>

  <p class="text-primary small mb-3">
    ðŸ’µ Total Cost:
    <span id="total-cost"><%= display_price((@product.price || 0) + (@product.shipping_cost || 0)) %></span>
  </p>

  <!-- Images / Gallery (unchanged except presence) -->
  <div class="mb-3">
    <%= form.label :image_url, "Main Product Image", class: "form-label small" %>
    <% if @product.image_url.present? %>
      <div class="mb-2"><%= image_tag @product.image_url, class: "img-fluid rounded shadow-sm", style: "max-height: 250px;" %></div>
    <% end %>
    <%= file_field_tag "product[image]", class: "form-control form-control-sm", accept: "image/*", onchange: "previewMainImage(event)" %>
    <img id="main-image-preview" class="img-fluid mt-2 rounded shadow-sm" style="max-height: 250px; display: none;" />
  </div>

  <div class="mb-3">
    <%= form.label :gallery_image_urls, "Gallery Images", class: "form-label small" %>
    <% if @product.gallery_image_urls.present? %>
      <div class="row g-2 mb-2">
        <% @product.gallery_image_urls.each do |url| %>
          <div id="gallery_image_<%= Digest::MD5.hexdigest(url) %>" class="col-4 text-center gallery-image-block">
            <%= image_tag url, class: "img-fluid rounded shadow-sm mb-1" %>
            <%= button_to "Delete", remove_gallery_product_path(@product, url: url), method: :delete, form: { data: { turbo_confirm: "Remove this image?" } }, class: "btn btn-sm btn-outline-danger" %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div id="gallery-inputs">
      <%= file_field_tag "gallery_images[]", multiple: true, class: "form-control form-control-sm mb-2", accept: "image/*", onchange: "previewGalleryImages(event)" %>
    </div>

    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addGalleryInput()">âž• Add More Images</button>
    <div id="gallery-preview" class="row mt-2 sortable-preview"></div>
  </div>

  <!-- ================= Variants ================= -->
  <h5 class="mb-2">Variants</h5>

  <div id="variant-fields">
    <%= form.fields_for :variants do |variant_fields| %>
      <%= variant_fields.hidden_field :id %>
      <%= render "variant_fields", f: variant_fields, product: @product %>
    <% end %>
  </div>

  <!-- Hidden template for NEW variant fields (client-side cloning) -->
  <div id="variant-template" style="display:none;">
    <div class="border p-3 mb-2 bg-light rounded variant-block" data-key="NEW_RECORD" id="variant_NEW_RECORD">
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label small">Type</label>
          <select name="product[variants_attributes][NEW_RECORD][name]" class="form-select form-select-sm variant-type">
            <option value="">Select type</option>
            <option value="Color">Color</option>
            <option value="Size">Size</option>
            <option value="Storage">Storage</option>
            <option value="Material">Material</option>
            <option value="Packaging">Packaging</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label small">Option</label>
          <select name="product[variants_attributes][NEW_RECORD][value]" class="form-select form-select-sm variant-value"></select>
        </div>

        <div class="col-md-3">
          <label class="form-label small">Price Modifier</label>
          <input type="number" step="0.01" name="product[variants_attributes][NEW_RECORD][price_modifier]" placeholder="e.g. 50.00" class="form-control form-control-sm" />
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <input type="hidden" name="product[variants_attributes][NEW_RECORD][_destroy]" class="destroy-flag" />
          <button type="button" class="btn btn-sm btn-outline-danger delete-variant">Delete</button>
        </div>
      </div>

      <div class="mt-2 color-image-actions d-none">
        <div class="variant-images-wrapper"></div>
        <button type="button" class="btn btn-sm btn-outline-secondary add-variant-image-btn">âž• Add color image</button>
      </div>
    </div>
  </div>

  <!-- Add Variant: edit uses Turbo stream, new uses JS clone -->
  <div class="mt-2">
    <% if @product.persisted? %>
      <%= button_to "âž• Add Variant", add_variant_product_path(@product), method: :post, data: { turbo_stream: true }, class: "btn btn-sm btn-outline-primary" %>
    <% else %>
      <button type="button" class="btn btn-sm btn-outline-primary add-variant-btn">âž• Add Variant</button>
    <% end %>
  </div>

  <div id="variants_count"><%= @product.variants.count %></div>

  <!-- Global variant-image template (used by JS cloning) -->
  <div id="variant-image-template" style="display:none;">
    <div class="border p-2 mb-2 bg-light rounded variant-image-block">
      <input type="file" name="product[variants_attributes][INDEX][variant_images_attributes][NEW_IMAGE][image]" class="form-control form-control-sm variant-image-input" accept="image/*" onchange="previewVariantImage(event)"/>
      <input type="hidden" name="product[variants_attributes][INDEX][variant_images_attributes][NEW_IMAGE][image_url]" class="image-url-field" />
      <input type="hidden" name="product[variants_attributes][INDEX][variant_images_attributes][NEW_IMAGE][_destroy]" class="destroy-flag" />
      <button type="button" class="btn btn-sm btn-outline-danger delete-variant-image">Delete</button>
    </div>
  </div>

  <!-- INVENTORY and rest unchanged... -->
  <div class="mb-4">
    <label class="form-label small fw-semibold">Inventory</label>
    <div id="inventory-fields">
      <%= form.fields_for :inventories do |inv_fields| %>
        <div class="border p-2 mb-2 bg-light rounded">
          <%= inv_fields.hidden_field :id %>
          <%= inv_fields.text_field :location, placeholder: "e.g. Nairobi Warehouse", class: "form-control form-control-sm mb-1" %>
          <%= inv_fields.number_field :quantity, min: 0, class: "form-control form-control-sm mb-1" %>
          <div class="form-check">
            <%= inv_fields.check_box :_destroy, class: "form-check-input" %>
            <%= inv_fields.label :_destroy, "Remove", class: "form-check-label small" %>
          </div>
        </div>
      <% end %>
    </div>
    <div id="inventory-template" style="display:none;">
      <div class="border p-2 mb-2 bg-light rounded">
        <input type="text" name="product[inventories_attributes][NEW_RECORD][location]" placeholder="e.g. Nairobi Warehouse" class="form-control form-control-sm mb-1" />
        <input type="number" name="product[inventories_attributes][NEW_RECORD][quantity]" min="0" class="form-control form-control-sm mb-1" />
        <div class="form-check">
          <input type="checkbox" name="product[inventories_attributes][NEW_RECORD][_destroy]" class="form-check-input" />
          <label class="form-check-label small">Remove</label>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <%= form.label :inventory_csv, "Upload CSV", class: "form-label small fw-semibold" %>
    <%= form.file_field :inventory_csv, class: "form-control form-control-sm", accept: ".csv" %>
  </div>

  <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addFields('inventory-fields')">âž• Add Inventory</button>

  <div class="mt-3">
    <%= form.submit(@product.persisted? ? "Update Product" : "Save Product", class: "btn btn-primary w-100 fw-semibold") %>
  </div>

<% end %>
