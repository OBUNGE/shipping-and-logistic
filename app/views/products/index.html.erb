<!-- üìÑ File: app/views/products/index.html.erb -->
<div class="container-fluid py-4 bg-light">

  <!-- üß≠ Sticky Category Bar -->
  <div class="category-bar sticky-top bg-white py-2 px-3 mb-3 d-flex align-items-center gap-3 overflow-auto border-bottom shadow-sm"
       style="top: 65px; z-index: 1050; white-space: nowrap;">
    <% Category.where(parent_id: nil).each do |category| %>
      <%= link_to products_path(category: category.slug),
          class: "category-pill px-3 py-2 rounded-pill text-dark fw-semibold text-decoration-none border hover-glow" do %>
        <%= category_icon(category.name) %>
        <span class="ms-2"><%= category.name %></span>
      <% end %>
    <% end %>
  </div>

  <!-- üîç Search Bar -->
  <div class="sticky-top bg-white shadow-sm py-2 px-3 mb-4" style="top: 115px; z-index: 1040;">
    <form action="<%= products_path %>" method="get" class="d-flex">
      <input type="text" name="query" class="form-control form-control-lg me-2 rounded-pill shadow-sm"
             placeholder="Search for products, sellers or categories..." value="<%= params[:query] %>">
      <button class="btn btn-lg btn-primary rounded-pill px-4">
        <i class="bi bi-search"></i> Search
      </button>
    </form>
  </div>

  <div class="row">
    <!-- üìÅ Sidebar -->
    <aside class="col-12 col-md-3 col-lg-2 mb-4 d-none d-md-block">
      <div class="accordion rounded-3 shadow-sm bg-white" id="categoryAccordion" style="top: 180px; position: sticky;">
        <% Category.where(parent_id: nil).includes(:subcategories).each_with_index do |category, idx| %>
          <div class="accordion-item border-0">
            <h2 class="accordion-header" id="heading-<%= idx %>">
              <button class="accordion-button collapsed fw-semibold small" type="button"
                      data-bs-toggle="collapse" data-bs-target="#collapse-<%= idx %>">
                <%= category_icon(category.name) %>
                <span class="ms-2"><%= category.name %></span>
              </button>
            </h2>
            <div id="collapse-<%= idx %>" class="accordion-collapse collapse">
              <div class="accordion-body p-2">
                <ul class="list-unstyled mb-0">
                  <% category.subcategories.each do |sub| %>
                    <li>
                      <%= link_to sub.name,
                          products_path(category: category.slug, subcategory: sub.slug),
                          class: "d-block py-1 ps-3 text-muted small link-hover" %>
                    </li>
                  <% end %>
                </ul>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </aside>

    <!-- üõçÔ∏è Product Grid -->
    <main class="col-12 col-md-9 col-lg-10">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold text-dark fs-5 mb-0">üõçÔ∏è All Products</h2>
        <% if user_signed_in? && current_user.seller? %>
          <%= link_to "+ Add Product", new_product_path, class: "btn btn-primary btn-sm rounded-pill px-3 shadow-sm" %>
        <% end %>
      </div>

      <div class="row g-3">
        <% @products.each do |product| %>
          <% seller = product.seller %>
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card h-100 border-0 shadow-sm rounded-4 hover-zoom">
              <!-- üñºÔ∏è Image -->
              <div class="ratio ratio-1x1 bg-light">
                <% if product.image_url.present? %>
                  <%= image_tag product.image_url, alt: product.title,
                                class: "card-img-top rounded-top object-fit-cover" %>
                <% else %>
                  <%= image_tag asset_path("placeholder.jpg"), alt: "No image available",
                                class: "card-img-top rounded-top object-fit-cover" %>
                <% end %>
              </div>

              <!-- üì¶ Details -->
              <div class="card-body d-flex flex-column p-3">
                <h6 class="fw-semibold text-truncate mb-1">
                  <%= link_to product.title, product_path(product),
                      class: "text-dark text-decoration-none hover-link" %>
                </h6>

                <!-- üí∏ Price with discount -->
                <% if product.discount.present? && product.discount.percentage.to_f > 0 %>
                  <% discounted_price = product.price * (1 - product.discount.percentage / 100.0) %>
                  <p class="small mb-1">
                    <span class="text-muted text-decoration-line-through me-2">
                      <%= display_price(product.price, user: current_user) %>
                    </span>
                    <span class="text-danger fw-bold">
                      <%= display_price(discounted_price, user: current_user) %>
                    </span>
                  </p>
                  <span class="badge bg-success mb-1">-<%= product.discount.percentage.to_i %>% Off</span>
                <% else %>
                  <p class="text-primary fw-bold small mb-1">
                    <%= display_price(product.price, user: current_user) %>
                  </p>
                <% end %>

                <p class="small mb-1 <%= product.stock.to_i > 0 ? 'text-success' : 'text-danger' %>">
                  <%= product.stock.to_i > 0 ? "‚úÖ In Stock" : "‚ùå Out of Stock" %>
                </p>

                <% if seller&.store_slug.present? %>
                  <p class="small text-muted mb-2">
                    
                    <%= link_to (seller.company_name || seller.name),
                        seller_path(seller.store_slug),
                        class: "fw-semibold text-decoration-none hover-link" %>
                  </p>
                <% end %>

                <div class="mt-auto d-flex gap-2">
                  <%= link_to "View", product_path(product), class: "btn btn-sm btn-outline-primary flex-fill rounded-pill" %>
                  <% if product.stock.to_i > 0 %>
                    <%= button_to "Add to Cart", add_cart_path,
                        method: :post,
                        params: { product_id: product.id },
                        remote: true,
                        form: { data: { turbo_stream: true } },
                        class: "btn btn-sm btn-success flex-fill rounded-pill" %>
                  <% else %>
                    <button class="btn btn-sm btn-secondary flex-fill rounded-pill" disabled>Out of Stock</button>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </main>
  </div>
</div>


