<div class="container-fluid py-3">
  <!-- üîù Sticky Scrollable Category Bar -->
  <div class="category-bar sticky-top bg-white py-2 px-3 mb-3 d-flex align-items-center gap-3 shadow-sm overflow-auto"
       style="top: 60px; z-index: 1050;">
    <% Category.where(parent_id: nil).each do |category| %>
      <%= link_to products_path(category: category.slug),
          class: "category-pill d-flex align-items-center px-3 py-2 text-decoration-none rounded-pill shadow-sm" do %>
        <span class="me-2"><%= category_icon(category.name) %></span>
        <span class="fw-semibold small"><%= category.name %></span>
      <% end %>
    <% end %>
  </div>

  <!-- üîç Sticky Search Bar -->
  <div class="sticky-top bg-white shadow-sm py-2 px-3 mb-3" style="top: 110px; z-index: 1020;">
    <form action="<%= products_path %>" method="get" class="d-flex">
      <input type="text" name="query" class="form-control me-2" placeholder="Search products..." value="<%= params[:query] %>" />
      <button class="btn btn-primary">Search</button>
    </form>
  </div>

  <div class="row">
    <!-- üìÇ Sidebar Categories -->
    <aside class="col-12 col-md-3 col-lg-2 mb-4 d-none d-md-block">
      <div class="accordion sticky-top shadow-sm rounded-3" id="categoryAccordion" style="top: 170px;">
        <% Category.where(parent_id: nil).includes(:subcategories).each_with_index do |category, idx| %>
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-<%= idx %>">
              <button class="accordion-button collapsed py-2 fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= idx %>">
                <%= category_icon(category.name) %> <span class="ms-2"><%= category.name %></span>
              </button>
            </h2>
            <div id="collapse-<%= idx %>" class="accordion-collapse collapse">
              <div class="accordion-body py-2">
                <ul class="list-unstyled mb-0">
                  <% category.subcategories.each do |sub| %>
                    <li>
                      <%= link_to sub.name,
                          products_path(category: category.slug, subcategory: sub.slug),
                          class: "text-decoration-none small d-block py-1 link-hover" %>
                    </li>
                  <% end %>
                </ul>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </aside>

    <!-- üõçÔ∏è Main Product Grid -->
    <main class="col-12 col-md-9 col-lg-10">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fs-5 fw-semibold mb-0">üõçÔ∏è All Products</h2>
        <% if user_signed_in? && current_user.seller? %>
          <%= link_to "‚ûï Add Product", new_product_path, class: "btn btn-sm btn-primary shadow-sm" %>
        <% end %>
      </div>

      <div class="row g-3">
        <% @products.each do |product| %>
          <% seller = product.seller %>
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card h-100 border-0 shadow-sm rounded-3 hover-shadow transition-all">
              <!-- üñºÔ∏è Product Image -->
              <div class="ratio ratio-1x1">
                <% if product.image_url.present? %>
                  <%= image_tag product.image_url,
                                alt: product.title,
                                class: "card-img-top rounded-top object-fit-cover",
                                style: "object-fit: cover; width: 100%; height: 100%;" %>
                <% else %>
                  <%= image_tag asset_path("placeholder.jpg"),
                                alt: "No image available",
                                class: "card-img-top rounded-top object-fit-cover",
                                style: "object-fit: cover; width: 100%; height: 100%;" %>
                <% end %>
              </div>

              <!-- Product Info -->
              <div class="card-body d-flex flex-column p-2">
                <h6 class="text-truncate mb-1 small fw-semibold">
                  <%= link_to product.title, product_path(product), class: "text-dark text-decoration-none link-hover" %>
                </h6>

                <p class="text-primary fw-bold small mb-1">
                  <%= display_price(product.price, user: current_user) %>
                </p>

                <p class="small <%= product.stock.to_i > 0 ? 'text-success' : 'text-danger' %> mb-1">
                  <%= product.stock.to_i > 0 ? "‚úÖ In Stock" : "‚ùå Out of Stock" %>
                </p>

                <% if seller&.store_slug.present? %>
                  <p class="small text-muted mb-2">
                    Sold by: <%= link_to (seller.company_name || seller.name), seller_path(seller.store_slug),
                        class: "fw-semibold text-decoration-none link-hover" %>
                  </p>
                <% end %>

                <div class="mt-auto d-flex gap-2">
                  <%= link_to "View", product_path(product), class: "btn btn-sm btn-outline-primary flex-fill" %>
                  <% if product.stock.to_i > 0 %>
                    <%= button_to "Add to Cart", add_cart_path,
    method: :post,
    params: { product_id: product.id },
    remote: true,
    form: { data: { turbo_stream: true } },
    class: "btn btn-sm btn-success flex-fill" %>
                  <% else %>
                    <button class="btn btn-sm btn-secondary flex-fill" disabled>Out of Stock</button>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </main>
  </div>
</div>
