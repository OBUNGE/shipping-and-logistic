<h2 class="fs-4 fw-semibold mb-3">ðŸ›’ Add New Product</h2>
<%= render "form", product: @product %>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const priceField = document.getElementById("product_price");
  const shippingField = document.getElementById("product_shipping_cost");
  const totalCostSpan = document.getElementById("total-cost");

  function updateTotal() {
    const price = parseFloat(priceField?.value) || 0;
    const shipping = parseFloat(shippingField?.value) || 0;
    const total = price + shipping;
    if (totalCostSpan) totalCostSpan.textContent = `KES ${total.toFixed(2)}`;
  }

  priceField?.addEventListener("input", updateTotal);
  shippingField?.addEventListener("input", updateTotal);
});

// --- Main image preview ---
function previewMainImage(event) {
  const output = document.getElementById("main-image-preview");
  const file = event.target.files[0];
  if (file && output) {
    output.src = URL.createObjectURL(file);
    output.onload = () => URL.revokeObjectURL(output.src);
    output.style.display = "block";
  } else if (output) {
    output.src = "";
    output.style.display = "none";
  }
}

// --- Gallery image preview ---
function previewGalleryImages(event) {
  const previewContainer = document.getElementById("gallery-preview");
  if (!previewContainer) return;
  previewContainer.innerHTML = "";

  Array.from(event.target.files).forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const wrapper = document.createElement("div");
      wrapper.className = "col-md-3 mb-2 text-center preview-item";
      wrapper.draggable = true;
      wrapper.dataset.index = index;

      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "img-thumbnail";
      img.style.maxHeight = "150px";

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn btn-sm btn-outline-danger mt-2";
      removeBtn.textContent = "Remove";
      removeBtn.onclick = () => wrapper.remove();

      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      previewContainer.appendChild(wrapper);
    };
    reader.readAsDataURL(file);
  });
}

// --- Variant image preview ---
function previewVariantImage(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    let preview = event.target.closest(".variant-image-block")
                              .querySelector(".variant-image-preview");
    if (!preview) {
      preview = document.createElement("img");
      preview.className = "img-thumbnail mt-2 variant-image-preview";
      event.target.closest(".variant-image-block").appendChild(preview);
    }
    preview.src = e.target.result;
    preview.style.maxHeight = "120px";
  };
  reader.readAsDataURL(file);
}

// --- Drag-and-drop sorting for gallery preview ---
document.addEventListener("DOMContentLoaded", () => {
  const container = document.querySelector(".sortable-preview");
  let dragged;

  container?.addEventListener("dragstart", (e) => {
    dragged = e.target.closest(".preview-item");
    if (dragged) dragged.style.opacity = 0.5;
  });

  container?.addEventListener("dragend", () => {
    if (dragged) dragged.style.opacity = "";
  });

  container?.addEventListener("dragover", (e) => {
    e.preventDefault();
  });

  container?.addEventListener("drop", (e) => {
    e.preventDefault();
    const target = e.target.closest(".preview-item");
    if (target && dragged && dragged !== target) {
      container.insertBefore(dragged, target);
    }
  });
});
// ----------------------------------------------
//  Variant & Inventory Dynamic Fields
// ----------------------------------------------
document.addEventListener("turbo:load", () => {

  const typeOptions = {
    Size: ["XS","S","M","L","XL","XXL","3XL","4XL","5XL","6XL","7XL","8XL","9XL","10XL"],
    Color: ["Red","Blue","Black","White","Green","Yellow","Purple","Orange","Pink","Gray","Brown","Cyan","Magenta","Lime","Teal","Navy","Maroon","Olive","Silver","Gold","Beige"],
    Material: ["Cotton","Leather","Polyester","Plastic","Metal","Wood","Glass","Silk","Wool","Denim"],
    Storage: ["64GB","128GB","256GB","512GB","1TB","2TB","4TB"],
    Packaging: ["Box","Bag","Sachet","Envelope","Bottle","Jar"]
  };

  // -----------------------------
  // 1. Update Value Options
  // -----------------------------
  function updateValueOptions(typeSelect) {
    const selected = typeSelect.value;
    const block = typeSelect.closest(".variant-block");
    const valueSelect = block.querySelector(".variant-value");
    const actions = block.querySelector(".color-image-actions");

    valueSelect.innerHTML = "";
    const options = typeOptions[selected] || [];

    options.forEach(opt => {
      const option = document.createElement("option");
      option.value = opt;
      option.textContent = opt;
      valueSelect.appendChild(option);
    });

    // Show image upload if Color
    actions.classList.toggle("d-none", selected !== "Color");
    if (selected === "Color") bindAddImageButtons(block);
  }

  function bindVariantDropdowns(container) {
    container.querySelectorAll(".variant-type").forEach(sel => {
      updateValueOptions(sel);
      sel.addEventListener("change", () => updateValueOptions(sel));
    });
  }

  // -----------------------------
  // 2. Delete Buttons
  // -----------------------------
  function bindDeleteButtons(container) {
    container.querySelectorAll(".delete-variant").forEach(btn => {
      btn.addEventListener("click", () => {
        const block = btn.closest(".variant-block");
        block.querySelector("input.destroy-flag").value = "true";
        block.style.display = "none";
      });
    });

    container.querySelectorAll(".delete-variant-image").forEach(btn => {
      btn.addEventListener("click", () => {
        const block = btn.closest(".variant-image-block");
        block.querySelector("input.destroy-flag").value = "true";
        block.style.display = "none";
      });
    });

    container.querySelectorAll(".delete-gallery-image").forEach(btn => {
      btn.addEventListener("click", () => {
        const url = btn.dataset.url;
        const form = btn.closest("form");
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "remove_gallery[]";
        hidden.value = url;
        form.appendChild(hidden);

        btn.closest(".gallery-image-block").style.display = "none";
      });
    });
  }

  // -----------------------------
  // 3. Add Variant Image
  // -----------------------------
  function addVariantImageToBlock(variantBlock) {
    const template = document.getElementById("variant-image-template").innerHTML;

    const parentInput = variantBlock.querySelector("input[name*='variants_attributes']");
    const parentIdMatch = parentInput?.name.match(/variants_attributes\]\[(new_\d+|\d+)\]/);
    const parentId = parentIdMatch ? parentIdMatch[1] : `new_${Date.now()}`;

    const uniqueImageId = `new_${Date.now()}`;

    const html = template
      .replace(/NEW_RECORD/g, parentId)
      .replace(/NEW_IMAGE/g, uniqueImageId);

    const wrapper = document.createElement("div");
    wrapper.innerHTML = html.trim();

    const block = wrapper.firstElementChild;
    variantBlock.querySelector(".color-image-actions").append(block);

    bindDeleteButtons(block);
  }

  function bindAddImageButtons(container) {
    container.querySelectorAll(".add-variant-image-btn").forEach(btn => {
      btn.removeEventListener("click", btn._click);
      btn._click = () => {
        const block = btn.closest(".variant-block");
        addVariantImageToBlock(block);
      };
      btn.addEventListener("click", btn._click);
    });
  }

  // -----------------------------
  // 4. Add Fields (variant/inventory)
  // -----------------------------
  window.addFields = function(containerId) {
    const container = document.getElementById(containerId);
    const template = document.getElementById(containerId.replace("-fields", "-template")).innerHTML;

    const unique = `new_${Date.now()}`;
    const html = template.replace(/NEW_RECORD/g, unique);

    const wrapper = document.createElement("div");
    wrapper.innerHTML = html.trim();

    const block = wrapper.firstElementChild;
    container.append(block);

    bindVariantDropdowns(block);
    bindDeleteButtons(block);
    bindAddImageButtons(block);
  };

  // -----------------------------
  // Initial Calls
  // -----------------------------
  bindVariantDropdowns(document);
  bindDeleteButtons(document);
  bindAddImageButtons(document);
});
</script>