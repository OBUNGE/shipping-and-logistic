<h2 class="fs-4 fw-semibold mb-3">ðŸ›’ Add New Product</h2>
<%= render "form", product: @product %>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const priceField = document.getElementById("product_price");
  const shippingField = document.getElementById("product_shipping_cost");
  const totalCostSpan = document.getElementById("total-cost");

  function updateTotal() {
    const price = parseFloat(priceField.value) || 0;
    const shipping = parseFloat(shippingField.value) || 0;
    const total = price + shipping;
    totalCostSpan.textContent = `KES ${total.toFixed(2)}`; // âœ… Default currency KES
  }

  priceField?.addEventListener("input", updateTotal);
  shippingField?.addEventListener("input", updateTotal);
});

// --- Main image preview ---
function previewMainImage(event) {
  const output = document.getElementById("main-image-preview");
  const file = event.target.files[0];
  if (file) {
    output.src = URL.createObjectURL(file);
    output.onload = () => URL.revokeObjectURL(output.src);
    output.style.display = "block";
  } else {
    output.src = "";
    output.style.display = "none";
  }
}

// --- Gallery image preview ---
function previewGalleryImages(event) {
  const previewContainer = document.getElementById("gallery-preview");
  previewContainer.innerHTML = "";

  Array.from(event.target.files).forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const wrapper = document.createElement("div");
      wrapper.className = "col-md-3 mb-2 text-center preview-item";
      wrapper.draggable = true;
      wrapper.dataset.index = index;

      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "img-thumbnail";
      img.style.maxHeight = "150px";

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn btn-sm btn-outline-danger mt-2";
      removeBtn.textContent = "Remove";
      removeBtn.onclick = () => wrapper.remove();

      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      previewContainer.appendChild(wrapper);
    };
    reader.readAsDataURL(file);
  });
}

// --- Drag-and-drop sorting for gallery preview ---
document.addEventListener("DOMContentLoaded", () => {
  const container = document.querySelector(".sortable-preview");
  let dragged;

  container?.addEventListener("dragstart", (e) => {
    dragged = e.target.closest(".preview-item");
    if (dragged) dragged.style.opacity = 0.5;
  });

  container?.addEventListener("dragend", () => {
    if (dragged) dragged.style.opacity = "";
  });

  container?.addEventListener("dragover", (e) => {
    e.preventDefault();
  });

  container?.addEventListener("drop", (e) => {
    e.preventDefault();
    const target = e.target.closest(".preview-item");
    if (target && dragged && dragged !== target) {
      container.insertBefore(dragged, target);
    }
  });
});

// âœ… Variant & Inventory Dynamic Fields
document.addEventListener("turbo:load", () => {
  const typeOptions = {
    Size: ["XS","S","M","L","XL","XXL","3XL","4XL","5XL","6XL","7XL","8XL","9XL","10XL"],
    Color: ["Red","Blue","Black","White","Green","Yellow","Purple","Orange","Pink","Gray","Brown","Cyan","Magenta","Lime","Teal","Navy","Maroon","Olive","Silver","Gold","Beige"],
    Material: ["Cotton","Leather","Polyester","Plastic","Metal","Wood","Glass","Silk","Wool","Denim"],
    Storage: ["64GB","128GB","256GB","512GB","1TB","2TB","4TB"],
    Packaging: ["Box","Bag","Sachet","Envelope","Bottle","Jar"]
  };

  // --- Variant dropdowns ---
  function updateValueOptions(typeSelect) {
    const selectedType = typeSelect.value;
    const block = typeSelect.closest(".variant-block");
    const valueSelect = block.querySelector(".variant-value");
    const actions = block.querySelector(".color-image-actions");

    if (valueSelect && valueSelect.tagName.toLowerCase() === "select") {
      valueSelect.innerHTML = "";
      const options = typeOptions[selectedType] || [];
      if (options.length === 0) {
        const fallback = document.createElement("option");
        fallback.textContent = "No options available";
        fallback.disabled = true;
        valueSelect.appendChild(fallback);
      } else {
        options.forEach(opt => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          valueSelect.appendChild(option);
        });
      }
    }

    if (actions) {
      actions.classList.toggle("d-none", selectedType !== "Color");
      if (selectedType === "Color") {
        bindAddImageButtons(block);
      }
    }
  }

  function bindVariantDropdowns(container) {
    container.querySelectorAll(".variant-block .variant-type").forEach(typeSelect => {
      updateValueOptions(typeSelect);
      typeSelect.addEventListener("change", () => updateValueOptions(typeSelect));
    });
  }

  // --- Delete buttons (gallery, variant, inventory) ---
  function bindDeleteButtons(container) {
    container.querySelectorAll(".delete-gallery-image").forEach(button => {
      button.addEventListener("click", (e) => {
        const block = e.target.closest(".gallery-image-block");
        const destroyField = block.querySelector("input.destroy-flag");
        if (destroyField) destroyField.value = "true"; // mark for removal
        block.style.display = "none";
      });
    });

    container.querySelectorAll(".delete-variant").forEach(button => {
      button.addEventListener("click", (e) => {
        const block = e.target.closest(".variant-block");
        const destroyField = block.querySelector("input.destroy-flag");
        if (destroyField) destroyField.value = "true";
        block.style.display = "none";
      });
    });

    container.querySelectorAll(".delete-variant-image").forEach(button => {
      button.addEventListener("click", (e) => {
        const block = e.target.closest(".variant-image-block");
        const destroyField = block.querySelector("input.destroy-flag");
        if (destroyField) destroyField.value = "true";
        block.style.display = "none";
      });
    });

    container.querySelectorAll(".remove-inventory").forEach(button => {
      button.addEventListener("click", (e) => {
        const block = e.target.closest(".inventory-block");
        const destroyField = block.querySelector("input.destroy-flag");
        if (destroyField) destroyField.value = "true";
        block.style.display = "none";
      });
    });
  }

  // --- Variant images ---
  function addVariantImageToBlock(variantBlock) {
    const templateHtml = document.getElementById("variant-image-template").innerHTML;
    if (!templateHtml) return;

    const uniqueId = new Date().getTime();
    const html = templateHtml
      .replace(/NEW_RECORD/g, `new_${uniqueId}`)
      .replace(/NEW_IMAGE/g, `new_${uniqueId}`);

    const wrapper = document.createElement("div");
    wrapper.innerHTML = html.trim();
    const imageBlock = wrapper.firstElementChild;

    if (imageBlock) {
      variantBlock.querySelector(".color-image-actions").appendChild(imageBlock);
      bindDeleteButtons(imageBlock);
    }
  }

  function bindAddImageButtons(container) {
    container.querySelectorAll(".variant-block .add-variant-image-btn").forEach(btn => {
      btn.removeEventListener("click", btn._boundClick);
      btn._boundClick = (e) => {
        const variantBlock = e.target.closest(".variant-block");
        addVariantImageToBlock(variantBlock);
      };
      btn.addEventListener("click", btn._boundClick);
    });
  }

  // --- Generic addFields ---
  window.addFields = function(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const templateId = containerId.replace("-fields", "-template");
    const templateEl = document.getElementById(templateId);
    if (!templateEl) {
      console.error("Template not found for", templateId);
      return;
    }

    const template = templateEl.innerHTML;
    const uniqueId = new Date().getTime();
    const newBlockHtml = template.replace(/NEW_RECORD/g, `new_${uniqueId}`);

    const wrapper = document.createElement("div");
    wrapper.innerHTML = newBlockHtml.trim(); 
      const newBlock = wrapper.firstElementChild;
    if (!newBlock) return;

    container.appendChild(newBlock);

    if (containerId === "variant-fields") {
      bindVariantDropdowns(newBlock);
      bindAddImageButtons(newBlock);
    }

    bindDeleteButtons(newBlock);
  };

  // --- Initial bindings ---
  bindVariantDropdowns(document);
  bindDeleteButtons(document);
  bindAddImageButtons(document);
});
</script>

