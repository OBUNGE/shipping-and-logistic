<div class="container my-5">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body p-4">
      <h1 class="mb-4 text-center fw-bold text-primary">üõí Your Shopping Cart</h1>

      <% if @cart_items.empty? %>
        <div class="text-center my-5">
          <%= image_tag asset_path("empty_cart.svg"), alt: "Empty cart",
                        class: "img-fluid opacity-75", style: "max-height: 250px;" %>
          <p class="mt-3 fs-5 text-muted">Your cart is currently empty.</p>
          <%= link_to "Browse Products", products_path,
                      class: "btn btn-primary px-4 py-2 rounded-pill fw-semibold mt-2" %>
        </div>
      <% else %>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-primary text-center">
              <tr>
                <th>Product</th>
                <th>Image</th>
                <th>Variants</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Subtotal</th>
                <th>Seller</th>
                <th>Delivery</th>
                <th></th>
              </tr>
            </thead>

            <tbody class="table-group-divider">
              <% @cart_items.each do |item| %>
                <% product   = item[:product] %>
                <% variants  = item[:variants] %>

                <tr>
                  <!-- Product title -->
                  <td>
                    <%= link_to product.title, product_path(product),
                          class: "text-decoration-none fw-semibold text-dark" %>
                  </td>

                  <!-- Image -->
                  <td class="text-center">
                    <% image_url = variants.map(&:primary_image_url).compact.first || product.primary_image_url.presence %>
                    <% if image_url.present? %>
                      <%= image_tag image_url,
                            class: "img-thumbnail border-0 rounded-3 shadow-sm",
                            style: "width: 70px; height: 70px; object-fit: cover;",
                            alt: "#{product.title} image" %>
                    <% else %>
                      <%= image_tag asset_path("placeholder.jpg"),
                            class: "img-thumbnail border-0 rounded-3 shadow-sm",
                            style: "width: 70px; height: 70px; object-fit: cover;",
                            alt: "No image" %>
                    <% end %>
                  </td>

                  <!-- Variants -->
                  <td class="text-center">
                    <% if variants.present? %>
                      <% variants.each do |v| %>
                        <span class="badge bg-info text-dark"><%= "#{v.name}: #{v.value}" %></span>
                      <% end %>
                    <% else %>
                      <span class="text-muted">‚Äî</span>
                    <% end %>
                  </td>

                  <!-- Quantity -->
                  <td class="text-center">
                    <%= form_with url: update_cart_path(product_id: product.id, variant_ids: variants.map(&:id)),
                                  method: :post, local: true do |f| %>
                      <div class="d-flex flex-column align-items-center">
                        <%= f.number_field :quantity, value: item[:quantity], min: 1,
                              class: "form-control form-control-sm text-center mb-1",
                              style: "width: 70px;" %>
                        <%= f.submit "Update", class: "btn btn-sm btn-outline-secondary rounded-pill" %>
                      </div>
                    <% end %>
                  </td>

                  <!-- Pricing -->
                  <td class="text-center"><%= number_to_currency(item[:unit_price], unit: "KES ") %></td>
                  <td class="text-center"><%= number_to_currency(item[:subtotal], unit: "KES ") %></td>

                  <!-- Seller -->
                  <td class="text-center"><%= product.seller.company_name.presence || product.seller.name.presence || "Unknown Seller" %></td>

                  <!-- Delivery -->
                  <td class="text-center"><%= product.delivery_estimate.presence || "‚Äî" %></td>

                  <!-- Remove -->
                  <td class="text-center">
                    <%= button_to "Remove",
                          remove_cart_path(product_id: product.id, variant_ids: variants.map(&:id)),
                          method: :post,
                          class: "btn btn-sm btn-danger rounded-pill",
                          aria: { label: "Remove #{product.title} from cart" } %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Totals -->
        <% subtotal = @cart_items.sum { |item| item[:subtotal] } %>

        <div class="row mt-5">
          <div class="col-md-6">
            <div class="card border-0 bg-light shadow-sm rounded-3">
              <div class="card-body">
                <h5 class="fw-bold text-secondary mb-3">Order Summary</h5>
                <div class="d-flex justify-content-between">
                  <span>Subtotal (Products):</span>
                  <strong><%= number_to_currency(subtotal, unit: "KES ") %></strong>
                </div>
                <p class="text-muted">Shipping will be calculated at checkout after you enter delivery details.</p>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="col-md-6 d-flex flex-column justify-content-center align-items-md-end mt-4 mt-md-0">
            <div class="d-flex flex-column flex-md-row gap-3">
              <%= button_to "üßπ Clear Cart", clear_cart_path,
                    method: :post,
                    class: "btn btn-outline-warning fw-semibold px-4 rounded-pill",
                    data: { confirm: "Are you sure you want to clear your cart?" } %>

              <%= link_to " Proceed to Checkout", new_order_path,
                    class: "btn btn-success fw-semibold px-4 rounded-pill" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
<div class="alert alert-info rounded-3 shadow-sm mt-3">
  <h6 class="fw-bold mb-2">üöö How Shipping is Calculated</h6>
  <div class="row text-center">
    <div class="col-md-4 mb-2">
      <div class="p-2 border rounded bg-light">
        <span class="fw-semibold">üè† Nairobi</span><br>
        <small>200 KES base + 50 KES per kg<br>
        ‚úÖ Free shipping above <strong>5000 KES</strong></small>
      </div>
    </div>
    <div class="col-md-4 mb-2">
      <div class="p-2 border rounded bg-light">
        <span class="fw-semibold">üåç Upcountry</span><br>
        <small>1.5√ó Nairobi rate<br>
        ‚úÖ Free shipping above <strong>7000 KES</strong></small>
      </div>
    </div>
    <div class="col-md-4 mb-2">
      <div class="p-2 border rounded bg-light">
        <span class="fw-semibold">‚úàÔ∏è International</span><br>
        <small>2√ó Nairobi rate<br>
        ‚úÖ Free shipping above <strong>10000 KES</strong></small>
      </div>
    </div>
  </div>
  <p class="small text-muted mt-2 mb-0">
    Shipping is calculated automatically after you enter your delivery details.
  </p>
</div>
